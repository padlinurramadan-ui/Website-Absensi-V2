<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Hadir Siswa 12 RPL - Multi Device Sync</title>
    <!-- By Padli Nurramadhan -->
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --primary-dark: #1e3a8a;
            --secondary: #60a5fa;
            --accent: #93c5fd;
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-700: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --orange: #f97316;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #dbeafe 100%);
            min-height: 100vh;
            color: var(--gray-700);
            overflow-x: hidden;
        }

        /* Video Background */
        .bg-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-video video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            object-fit: cover;
        }

        .bg-video::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(0px);
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .login-card {
            background: white;
            border-radius: 24px;
            padding: 3rem;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: white;
        }

        .login-title {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #64748b;
            margin-bottom: 2rem;
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .login-form input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(30, 64, 175, 0.3);
        }

        .login-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--gray-100);
            padding: 0.5rem;
            border-radius: 12px;
        }

        .login-tab {
            flex: 1;
            padding: 0.8rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            color: #64748b;
        }

        .login-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .login-tab:hover:not(.active) {
            color: var(--primary-dark);
        }

        /* Fingerprint Styles */
        .fingerprint-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--gray-100);
        }

        .fingerprint-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .fingerprint-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .fingerprint-btn:disabled {
            background: var(--gray-200);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .fingerprint-icon {
            font-size: 1.5rem;
        }

        .fingerprint-registered {
            background: linear-gradient(135deg, var(--info), #1d4ed8) !important;
        }

        .fingerprint-list {
            margin-top: 1rem;
            text-align: left;
        }

        .fingerprint-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem;
            background: var(--gray-50);
            border-radius: 10px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .fingerprint-item-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .fingerprint-item-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .fingerprint-item-name {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.9rem;
        }

        .fingerprint-item-date {
            font-size: 0.75rem;
            color: #64748b;
        }

        .fingerprint-delete {
            background: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .fingerprint-delete:hover {
            background: #fee2e2;
        }

        .fingerprint-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .fingerprint-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fingerprint-modal-content {
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
        }

        .fingerprint-animation {
            width: 120px;
            height: 120px;
            margin: 0 auto 1.5rem;
            position: relative;
        }

        .fingerprint-circle {
            width: 100%;
            height: 100%;
            border: 4px solid var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--gray-400);
            position: relative;
            overflow: hidden;
        }

        .fingerprint-circle.scanning {
            border-color: var(--primary);
            animation: pulse-ring 2s infinite;
        }

        .fingerprint-circle.success {
            border-color: var(--success);
            color: var(--success);
            animation: success-pulse 0.5s ease;
        }

        .fingerprint-circle.error {
            border-color: var(--danger);
            color: var(--danger);
            animation: shake 0.5s ease;
        }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        @keyframes success-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .fingerprint-status {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .fingerprint-hint {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            box-shadow: 0 10px 40px rgba(30, 64, 175, 0.3);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            font-size: 2.5rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .title-section h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .title-section p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .date-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Navigation Tabs */
        .nav-tabs {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem 0;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }

        .nav-tab {
            padding: 0.8rem 1.5rem;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 11;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-tab.active {
            background: white;
            color: var(--primary);
        }

        /* Chat Nav Button */
        .chat-nav-btn {
            padding: 0.8rem 1.5rem;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 11;
        }

        .chat-nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-nav-btn i {
            font-size: 1.2rem;
        }

        .chat-nav-btn .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            display: none;
        }

        .chat-nav-btn .chat-badge.show {
            display: flex;
        }

        /* Info Button in Nav */
        .info-nav-btn {
            padding: 0.8rem 1.5rem;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 11;
        }

        .info-nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .info-nav-btn i {
            font-size: 1.2rem;
        }

        /* Guide Button in Nav */
        .guide-nav-btn {
            padding: 0.8rem 1.5rem;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 11;
        }

        .guide-nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .guide-nav-btn i {
            font-size: 1.2rem;
        }

        /* Profile Modal */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .profile-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-card {
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 2.5rem 2rem;
            text-align: center;
            color: white;
            position: relative;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border: 4px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .profile-role {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .profile-body {
            padding: 2rem;
        }

        .profile-info-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.8rem;
            background: var(--gray-50);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .profile-info-item:hover {
            background: var(--gray-100);
            transform: translateX(5px);
        }

        .profile-info-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .profile-info-text {
            flex: 1;
        }

        .profile-info-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.2rem;
        }

        .profile-info-value {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.95rem;
        }

        .social-links {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin-top: 1.5rem;
        }

        .social-btn {
            padding: 0.8rem;
            border-radius: 12px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .social-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .social-btn.whatsapp {
            background: linear-gradient(135deg, #25d366, #128c7e);
        }

        .social-btn.instagram {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }

        .social-btn.facebook {
            background: linear-gradient(135deg, #1877f2, #0d5cb6);
        }

        .social-btn.github {
            background: linear-gradient(135deg, #333, #24292e);
        }

        .close-profile {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-profile:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        /* Guide Modal */
        .guide-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .guide-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .guide-card {
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        .guide-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1.5rem 2rem;
            text-align: center;
            color: white;
            position: relative;
        }

        .guide-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .guide-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .guide-search {
            margin-bottom: 1rem;
        }

        .guide-search input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .guide-search input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .guide-search-icon {
            position: relative;
        }

        .guide-search-icon i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-700);
        }

        .guide-class-section {
            margin-bottom: 1.5rem;
        }

        .guide-class-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .guide-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
        }

        .guide-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            background: var(--gray-50);
            border-radius: 10px;
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .guide-item:hover {
            background: var(--gray-100);
            transform: translateX(5px);
            border-color: var(--primary-light);
        }

        .guide-item-info {
            display: flex;
            flex-direction: column;
        }

        .guide-item-name {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.9rem;
        }

        .guide-item-code {
            font-family: monospace;
            font-size: 0.85rem;
            color: #64748b;
            background: var(--gray-200);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-top: 0.2rem;
            display: inline-block;
        }

        .guide-item-copy {
            background: var(--primary);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .guide-item-copy:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .close-guide {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-guide:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .guide-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .guide-stat-item {
            background: var(--gray-50);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        .guide-stat-item strong {
            color: var(--primary-dark);
        }

        /* Chat Modal Styles */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .chat-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-card {
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1.5rem;
            color: white;
            position: relative;
        }

        .chat-title {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.3rem;
        }

        .close-chat {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-chat:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-message {
            max-width: 80%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            position: relative;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.own {
            align-self: flex-end;
            background: #dcf8c6;
            border-bottom-right-radius: 4px;
        }

        .chat-message.other {
            align-self: flex-start;
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .chat-message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }

        .chat-message-sender {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--primary-dark);
        }

        .chat-message-time {
            font-size: 0.75rem;
            color: #667781;
        }

        .chat-message-text {
            font-size: 0.95rem;
            line-height: 1.4;
            color: #111b21;
            word-wrap: break-word;
        }

        .chat-input-container {
            padding: 1rem;
            background: white;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 24px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .chat-send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
        }

        .chat-empty-state {
            text-align: center;
            padding: 3rem;
            color: #667781;
        }

        .chat-empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .chat-date-divider {
            text-align: center;
            margin: 1rem 0;
            position: relative;
        }

        .chat-date-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gray-300);
        }

        .chat-date-divider span {
            background: #f0f2f5;
            padding: 0 1rem;
            font-size: 0.8rem;
            color: #667781;
            position: relative;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Stats Cards - Diubah menjadi grid 3 kolom tetap */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(30, 64, 175, 0.15);
        }

        .stat-card:hover::before {
            width: 100%;
            opacity: 0.05;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--white);
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            animation: iconPulse 2s infinite;
        }

        @keyframes iconPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); }
        }

        .stat-info h3 {
            font-size: 2rem;
            color: var(--primary-dark);
            margin-bottom: 0.2rem;
        }

        .stat-info p {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }

            .info-nav-btn, .guide-nav-btn, .chat-nav-btn {
                margin-left: 0;
                margin-top: 0.5rem;
                width: 100%;
                border-radius: 12px;
                justify-content: center;
            }

            .guide-list {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles */
        .card {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Scanner Section */
        .scanner-container {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
            border: 3px dashed var(--primary-light);
        }

        #reader {
            width: 100% !important;
            border: none !important;
        }

        #reader video {
            border-radius: 17px;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid var(--primary);
            border-radius: 20px;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }

        .scanner-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: var(--primary);
            top: 0;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 10px var(--primary);
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .scanner-status {
            text-align: center;
            padding: 1rem;
            background: var(--primary);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .scanner-status.scanning {
            animation: statusPulse 1.5s infinite;
        }

        @keyframes statusPulse {
            0%, 100% { background: var(--primary); }
            50% { background: var(--success); }
        }

        /* Manual Input */
        .manual-input {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .input-group {
            flex: 1;
            position: relative;
        }

        .input-group input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .input-group i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-700);
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #1d4ed8);
            color: white;
        }

        .btn-purple {
            background: linear-gradient(135deg, var(--purple), #7c3aed);
            color: white;
        }

        .btn-orange {
            background: linear-gradient(135deg, var(--orange), #ea580c);
            color: white;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--gray-200);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        thead {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
        }

        tbody tr {
            transition: all 0.2s ease;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        tbody tr:hover {
            background: var(--gray-50);
            transform: scale(1.01);
        }

        tbody tr:nth-child(even) {
            background: var(--gray-50);
        }

        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-purple {
            background: #ede9fe;
            color: #5b21b6;
        }

        .badge-orange {
            background: #ffedd5;
            color: #9a3412;
        }

        .badge-time {
            background: #dbeafe;
            color: var(--primary-dark);
            font-family: monospace;
        }

        /* Action Buttons */
        .action-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-footer {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Delete Button in Table */
        .btn-delete {
            background: transparent;
            color: var(--danger);
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #fee2e2;
            transform: scale(1.1);
        }

        .btn-bolos {
            background: transparent;
            color: var(--warning);
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .btn-bolos:hover {
            background: #fef3c7;
            transform: scale(1.1);
        }

        .btn-batal-bolos {
            background: transparent;
            color: var(--success);
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .btn-batal-bolos:hover {
            background: #d1fae5;
            transform: scale(1.1);
        }

        .btn-izin {
            background: transparent;
            color: var(--purple);
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .btn-izin:hover {
            background: #ede9fe;
            transform: scale(1.1);
        }

        .btn-sakit {
            background: transparent;
            color: var(--orange);
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .btn-sakit:hover {
            background: #ffedd5;
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .action-bar {
                justify-content: center;
            }
        }

        /* Success Animation */
        .success-check {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            animation: scaleIn 0.3s ease;
        }

        .success-check i {
            color: white;
            font-size: 2.5rem;
        }

        @keyframes scaleIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Barcode Sample Display */
        .barcode-samples {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .barcode-item {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--gray-200);
            transition: all 0.3s;
            cursor: pointer;
        }

        .barcode-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .barcode-visual {
            height: 60px;
            background: repeating-linear-gradient(
                90deg,
                #000 0px,
                #000 2px,
                #fff 2px,
                #fff 4px,
                #000 4px,
                #000 6px,
                #fff 6px,
                #fff 8px,
                #000 8px,
                #000 10px,
                #fff 10px,
                #fff 12px
            );
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .barcode-number {
            font-family: monospace;
            font-weight: bold;
            color: var(--primary-dark);
        }

        /* Barcode Generator Styles */
        .generator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 968px) {
            .generator-grid {
                grid-template-columns: 1fr;
            }
        }

        .barcode-preview {
            background: white;
            border: 2px dashed var(--gray-200);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .barcode-canvas {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            border-bottom: 1px solid var(--gray-100);
            transition: all 0.2s;
        }

        .student-item:hover {
            background: var(--gray-50);
        }

        .student-info {
            display: flex;
            flex-direction: column;
        }

        .student-name {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .student-id {
            font-size: 0.85rem;
            color: #64748b;
            font-family: monospace;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .format-options {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .format-btn {
            padding: 0.4rem 0.8rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .format-btn:hover, .format-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .hidden {
            display: none !important;
        }

        .tab-content {
            animation: fadeIn 0.3s ease;
        }

        .print-area {
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        /* Row styling for different statuses */
        tr.bolos {
            background: #fef2f2 !important;
            opacity: 0.8;
        }

        tr.bolos td {
            text-decoration: line-through;
            color: #991b1b;
        }

        tr.bolos .badge-success {
            background: #fee2e2;
            color: #991b1b;
        }

        tr.izin {
            background: #ede9fe !important;
        }

        tr.sakit {
            background: #ffedd5 !important;
        }

        /* Mobile Responsive Fixes */
        @media (max-width: 640px) {
            .container {
                padding: 0 1rem;
                margin: 1rem auto;
            }

            .card {
                padding: 1.5rem;
            }

            .title-section h1 {
                font-size: 1.4rem;
            }

            .title-section p {
                font-size: 0.8rem;
            }

            .date-display {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .logo-icon {
                font-size: 2rem;
            }

            .nav-tabs {
                padding: 1rem 1rem 0;
            }

            .nav-tab, .info-nav-btn, .guide-nav-btn, .chat-nav-btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .stat-info h3 {
                font-size: 1.5rem;
            }

            .stat-info p {
                font-size: 0.8rem;
            }

            .card-title {
                font-size: 1.1rem;
            }

            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            th, td {
                padding: 0.8rem;
                font-size: 0.85rem;
            }

            .barcode-samples {
                grid-template-columns: 1fr;
            }

            .action-bar {
                gap: 0.5rem;
            }

            .action-bar .btn {
                flex: 1;
                justify-content: center;
            }

            .manual-input {
                flex-direction: column;
            }

            .manual-input .btn {
                width: 100%;
                justify-content: center;
            }

            .generator-grid {
                gap: 1rem;
            }

            .barcode-preview {
                min-height: 200px;
                padding: 1rem;
            }

            .social-links {
                grid-template-columns: 1fr;
            }

            .profile-info-item {
                padding: 0.8rem;
            }

            .profile-info-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .profile-info-value {
                font-size: 0.9rem;
            }

            .modal-content {
                padding: 1.5rem;
            }

            .toast {
                min-width: auto;
                max-width: 90%;
            }

            .guide-card {
                max-height: 90vh;
            }

            .guide-body {
                padding: 1rem;
            }

            .guide-list {
                grid-template-columns: 1fr;
            }

            .login-card {
                padding: 2rem 1.5rem;
            }

            .fingerprint-section {
                margin-top: 1rem;
                padding-top: 1rem;
            }

            .fingerprint-item {
                padding: 0.6rem;
            }

            .fingerprint-item-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }

            .chat-card {
                width: 95%;
                height: 90vh;
            }

            .chat-message {
                max-width: 90%;
            }
        }

        /* Status Modal Styles */
        .status-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .status-option {
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .status-option.selected {
            border-color: var(--primary);
            background: var(--gray-50);
        }

        .status-option i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .status-option.hadir { color: var(--success); }
        .status-option.bolos { color: var(--danger); }
        .status-option.izin { color: var(--purple); }
        .status-option.sakit { color: var(--orange); }

        /* Quick Add Buttons */
        .quick-add-btns {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .quick-add-btns .btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        /* Rekap Styles */
        .rekap-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .rekap-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .rekap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .rekap-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .rekap-item {
            display: flex;
            justify-content: space-between;
            padding: 0.8rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .rekap-item:last-child {
            border-bottom: none;
        }

        .rekap-label {
            color: #64748b;
        }

        .rekap-value {
            font-weight: 700;
            color: var(--primary-dark);
        }

        .rekap-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .rekap-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Riwayat Styles */
        .riwayat-search {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .riwayat-result {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .riwayat-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .riwayat-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            color: white;
        }

        .riwayat-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .riwayat-info {
            color: #64748b;
            margin-top: 0.5rem;
        }

        .riwayat-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .riwayat-stat {
            text-align: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 12px;
        }

        .riwayat-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .riwayat-stat-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.3rem;
        }

        .riwayat-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            transform: scale(1.1);
        }

        .calendar-day.hadir { background: #d1fae5; color: #065f46; }
        .calendar-day.bolos { background: #fee2e2; color: #991b1b; }
        .calendar-day.izin { background: #ede9fe; color: #5b21b6; }
        .calendar-day.sakit { background: #ffedd5; color: #9a3412; }
        .calendar-day.empty { background: var(--gray-100); color: #94a3b8; }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
            font-weight: 700;
            color: #64748b;
            font-size: 0.85rem;
        }

        /* Sync Status Indicator */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 50px;
            font-size: 0.85rem;
        }

        .sync-status.online {
            color: #10b981;
        }

        .sync-status.offline {
            color: #f59e0b;
        }

        .sync-status.syncing {
            color: #3b82f6;
            animation: pulse 1.5s infinite;
        }

        /* Student View Specific Styles */
        .student-view-banner {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .student-view-banner i {
            font-size: 2rem;
        }

        .student-view-banner h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .student-view-banner p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.8rem 1.2rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .connection-status.connecting {
            background: #fef3c7;
            color: #92400e;
        }

        .connection-status.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* ============================================
           NEW FEATURE STYLES
           ============================================ */

        /* Push Notification Permission Button */
        .notification-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 2500;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
        }

        .notification-btn.denied {
            background: var(--danger);
        }

        .notification-btn.granted {
            background: var(--success);
        }

        /* Analytics Dashboard Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .analytics-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .analytics-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 4px;
            margin-top: 1rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .heatmap-legend {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .heatmap-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .heatmap-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .risk-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .risk-high {
            background: #fee2e2;
            color: #991b1b;
        }

        .risk-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .risk-low {
            background: #d1fae5;
            color: #065f46;
        }

        /* Backup & Restore Styles */
        .backup-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .backup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .backup-card {
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .backup-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(30, 64, 175, 0.1);
        }

        .backup-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .backup-icon.export {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .backup-icon.import {
            background: linear-gradient(135deg, var(--info), #1d4ed8);
        }

        .backup-icon.encrypt {
            background: linear-gradient(135deg, var(--purple), #7c3aed);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 1rem;
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .file-input-label:hover {
            background: var(--gray-100);
            border-color: var(--primary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Install PWA Button */
        .install-pwa-btn {
            position: fixed;
            bottom: 140px;
            right: 20px;
            padding: 0.8rem 1.2rem;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            display: none;
            align-items: center;
            gap: 0.5rem;
            z-index: 2500;
            animation: slideInRight 0.3s ease;
        }

        .install-pwa-btn.show {
            display: flex;
        }

        .install-pwa-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--warning);
            color: white;
            text-align: center;
            padding: 0.5rem;
            font-weight: 700;
            z-index: 4000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-indicator.show {
            transform: translateY(0);
        }

        /* Sync Queue Indicator */
        .sync-queue-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        /* Analytics Summary Cards */
        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-summary-item {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }

        .analytics-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .analytics-summary-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.3rem;
        }

        /* Prediction Card */
        .prediction-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .prediction-item:last-child {
            border-bottom: none;
        }

        .prediction-info {
            display: flex;
            flex-direction: column;
        }

        .prediction-name {
            font-weight: 700;
            color: var(--primary-dark);
        }

        .prediction-detail {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Responsive adjustments for new features */
        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .backup-grid {
                grid-template-columns: 1fr;
            }
            
            .heatmap-container {
                grid-template-columns: repeat(7, 1fr);
            }
        }

        /* Student Self Attendance Styles */
        .student-self-banner {
            background: linear-gradient(135deg, var(--info), #1d4ed8);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .student-self-banner i {
            font-size: 2rem;
        }

        .student-self-banner h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .student-self-banner p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .location-status {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .location-valid {
            background: #d1fae5;
            color: #065f46;
        }

        .location-invalid {
            background: #fee2e2;
            color: #991b1b;
        }

        .location-warning {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
<!-- By Padli Nurramadhan -->
    <!-- Video Background -->
    <div class="bg-video">
        <video autoplay muted loop playsinline>
            <source src="background.mp4" type="video/mp4">
            <!-- Fallback untuk browser yang tidak mendukung video -->
            Browser Anda tidak mendukung video tag.
        </video>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-qrcode"></i>
            </div>
            <h1 class="login-title">Sistem Absensi 12 RPL</h1>
            <p class="login-subtitle">Silakan login untuk melanjutkan</p>
            
            <!-- Login Tabs -->
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('admin')" id="tab-login-admin">
                    <i class="fas fa-user-shield"></i> Admin/Guru
                </button>
                <button class="login-tab" onclick="switchLoginTab('siswa')" id="tab-login-siswa">
                    <i class="fas fa-user-graduate"></i> Siswa
                </button>
            </div>
            
            <!-- Admin Login Form -->
            <form class="login-form" id="adminLoginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required placeholder="Masukkan username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required placeholder="Masukkan password">
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                
                <!-- Fingerprint Section for Admin -->
                <div class="fingerprint-section" id="adminFingerprintSection">
                    <button type="button" class="fingerprint-btn" id="adminFingerprintBtn" onclick="handleFingerprintLogin('admin')">
                        <i class="fas fa-fingerprint fingerprint-icon"></i>
                        <span id="adminFingerprintText">Login dengan Fingerprint</span>
                    </button>
                    <div class="fingerprint-list" id="adminFingerprintList" style="display: none;">
                        <!-- Registered fingerprints will be listed here -->
                    </div>
                </div>
            </form>
            
            <!-- Student Login Form -->
            <form class="login-form hidden" id="studentLoginForm" onsubmit="handleStudentLogin(event)">
                <div class="form-group">
                    <label>Nomor Barcode / NIS</label>
                    <input type="text" id="studentBarcode" required placeholder="Masukkan barcode (contoh: RPL1009)">
                </div>
                <div class="form-group">
                    <label>Tanggal Lahir (DDMMYYYY)</label>
                    <input type="password" id="studentPassword" required placeholder="Contoh: 01052006" maxlength="8">
                </div>
                <button type="submit" class="login-btn" style="background: linear-gradient(135deg, var(--success), #059669);">
                    <i class="fas fa-sign-in-alt"></i> Login sebagai Siswa
                </button>
                
                <!-- Fingerprint Section for Student -->
                <div class="fingerprint-section" id="studentFingerprintSection">
                    <button type="button" class="fingerprint-btn" id="studentFingerprintBtn" onclick="handleFingerprintLogin('student')">
                        <i class="fas fa-fingerprint fingerprint-icon"></i>
                        <span id="studentFingerprintText">Login dengan Fingerprint</span>
                    </button>
                    <p style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem; text-align: center;">
                        <i class="fas fa-info-circle"></i> 
                        Daftarkan fingerprint setelah login pertama kali
                    </p>
                    <div class="fingerprint-list" id="studentFingerprintList" style="display: none;">
                        <!-- Registered fingerprints will be listed here -->
                    </div>
                </div>
                
                <p style="margin-top: 1rem; font-size: 0.85rem; color: #64748b;">
                    <i class="fas fa-info-circle"></i> 
                    Siswa hanya dapat melihat riwayat absensi sendiri
                </p>
            </form>
        </div>
    </div>

    <!-- Fingerprint Registration Modal -->
    <div class="fingerprint-modal" id="fingerprintModal">
        <div class="fingerprint-modal-content">
            <div class="fingerprint-animation" id="fingerprintAnimation">
                <div class="fingerprint-circle" id="fingerprintCircle">
                    <i class="fas fa-fingerprint"></i>
                </div>
            </div>
            <div class="fingerprint-status" id="fingerprintStatus">Tempelkan Sidik Jari</div>
            <div class="fingerprint-hint" id="fingerprintHint">Gunakan sensor fingerprint pada device Anda</div>
            <button class="btn btn-secondary" onclick="closeFingerprintModal()" style="margin-top: 1.5rem;">
                <i class="fas fa-times"></i> Batal
            </button>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-card">
            <div class="chat-header">
                <button class="close-chat" onclick="closeChatModal()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="chat-title">
                    <i class="fas fa-comments"></i>
                    <span>Grup Admin 12 RPL</span>
                </div>
                <div class="chat-subtitle">
                    <i class="fas fa-users"></i> Administrator, Administrator 2, Guru BK, Wali Kelas
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-empty-state">
                    <i class="fas fa-comments"></i>
                    <p>Belum ada pesan. Mulai chat sekarang!</p>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter')sendChatMessage()">
                <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" class="hidden">
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status connecting hidden">
            <i class="fas fa-circle"></i>
            <span>Menghubungkan...</span>
        </div>

        <!-- Offline Indicator -->
        <div id="offlineIndicator" class="offline-indicator">
            <i class="fas fa-wifi-slash"></i> Anda sedang offline. Data akan disimpan secara lokal dan disinkronkan saat online.
        </div>

        <!-- Push Notification Button -->
        <button id="notificationBtn" class="notification-btn" onclick="requestNotificationPermission()" title="Aktifkan Notifikasi">
            <i class="fas fa-bell-slash"></i>
        </button>

        <!-- Install PWA Button -->
        <button id="installPwaBtn" class="install-pwa-btn" onclick="installPWA()">
            <i class="fas fa-download"></i> Install App
        </button>

        <!-- Profile Modal -->
        <div class="profile-modal" id="profileModal">
            <div class="profile-card">
                <div class="profile-header">
                    <button class="close-profile" onclick="closeProfileModal()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="profile-avatar">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="profile-name">Padli Nurramadhan</div>
                    <div class="profile-role">Web Developer</div>
                </div>
                <div class="profile-body">
                    <div class="profile-info-item">
                        <div class="profile-info-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info-text">
                            <div class="profile-info-label">Nama Lengkap</div>
                            <div class="profile-info-value">Padli Nurramadhan</div>
                        </div>
                    </div>
                    
                    <div class="profile-info-item">
                        <div class="profile-info-icon">
                            <i class="fas fa-birthday-cake"></i>
                        </div>
                        <div class="profile-info-text">
                            <div class="profile-info-label">Umur</div>
                            <div class="profile-info-value">17 Tahun</div>
                        </div>
                    </div>
                    
                    <div class="profile-info-item">
                        <div class="profile-info-icon">
                            <i class="fas fa-school"></i>
                        </div>
                        <div class="profile-info-text">
                            <div class="profile-info-label">Asal Sekolah</div>
                            <div class="profile-info-value">SMKS Saintek Nurul Muslimin Karawang</div>
                        </div>
                    </div>

                    <div class="social-links">
                        <a href="https://wa.me/6282249665662" target="_blank" class="social-btn whatsapp">
                            <i class="fab fa-whatsapp"></i>
                            <span>WhatsApp</span>
                        </a>
                        <a href="https://instagram.com/dlyy_suka_python" target="_blank" class="social-btn instagram">
                            <i class="fab fa-instagram"></i>
                            <span>Instagram</span>
                        </a>
                        <a href="https://www.facebook.com/Dlyy.fine" target="_blank" class="social-btn facebook">
                            <i class="fab fa-facebook-f"></i>
                            <span>Facebook</span>
                        </a>
                        <a href="https://github.com/padlinurramadan-ui" target="_blank" class="social-btn github">
                            <i class="fab fa-github"></i>
                            <span>GitHub</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guide Modal -->
        <div class="guide-modal" id="guideModal">
            <div class="guide-card">
                <div class="guide-header">
                    <button class="close-guide" onclick="closeGuideModal()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="guide-title">
                        <i class="fas fa-book"></i>
                        <span>Guide - Daftar Siswa Terdaftar</span>
                    </div>
                </div>
                <div class="guide-body">
                    <div class="guide-search-icon guide-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="guideSearch" placeholder="Cari nama atau kode..." oninput="filterGuide()">
                    </div>
                    
                    <div class="guide-stats">
                        <div class="guide-stat-item">
                            Total: <strong id="totalStudentsCount">0</strong> siswa
                        </div>
                        <div class="guide-stat-item">
                            XII RPL 1: <strong id="rpl1Count">0</strong>
                        </div>
                        <div class="guide-stat-item">
                            XII RPL 2: <strong id="rpl2Count">0</strong>
                        </div>
                    </div>

                    <div class="guide-class-section">
                        <div class="guide-class-title">
                            <i class="fas fa-users"></i>
                            XII RPL 1
                        </div>
                        <div class="guide-list" id="guideListRPL1">
                            <!-- Generated by JS -->
                        </div>
                    </div>

                    <div class="guide-class-section">
                        <div class="guide-class-title">
                            <i class="fas fa-users"></i>
                            XII RPL 2
                        </div>
                        <div class="guide-list" id="guideListRPL2">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="title-section">
                        <h1>Absensi Hadir Siswa 12 RPL</h1>
                        <p>Sistem Absensi Digital Berbasis Barcode</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="sync-status online" id="syncStatus">
                        <i class="fas fa-sync"></i>
                        <span id="syncText">Online</span>
                    </div>
                    <div class="user-info" id="userInfo">
                        <i class="fas fa-user-circle"></i>
                        <span>Admin</span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <div class="date-display">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="currentDate">Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs" id="adminNavTabs">
                <button class="nav-tab active" onclick="switchTab('absensi')" id="tab-absensi">
                    <i class="fas fa-clipboard-check"></i> Absensi
                </button>
                <button class="nav-tab" onclick="switchTab('analytics')" id="tab-analytics">
                    <i class="fas fa-chart-line"></i> Analytics
                </button>
                <button class="nav-tab" onclick="switchTab('rekap')" id="tab-rekap">
                    <i class="fas fa-chart-bar"></i> Rekap Bulanan
                </button>
                <button class="nav-tab" onclick="switchTab('riwayat')" id="tab-riwayat">
                    <i class="fas fa-history"></i> Riwayat Siswa
                </button>
                <button class="nav-tab" onclick="switchTab('backup')" id="tab-backup">
                    <i class="fas fa-database"></i> Backup
                </button>
                <button class="nav-tab" onclick="switchTab('generator')" id="tab-generator">
                    <i class="fas fa-barcode"></i> Generator Barcode
                </button>
                <button class="chat-nav-btn" onclick="openChatModal()" id="chatNavBtn">
                    <i class="fas fa-comments"></i>
                    <span>Chat Admin</span>
                    <span class="chat-badge" id="chatBadge">0</span>
                </button>
                <button class="guide-nav-btn" onclick="openGuideModal()">
                    <i class="fas fa-book"></i>
                    <span>Guide</span>
                </button>
                <button class="info-nav-btn" onclick="openProfileModal()">
                    <i class="fas fa-info-circle"></i>
                    <span>Info Developer</span>
                </button>
            </div>

            <!-- Student Navigation Tabs (Only Riwayat and Self Attendance) -->
            <div class="nav-tabs hidden" id="studentNavTabs">
                <button class="nav-tab" onclick="switchTab('studentAbsen')" id="tab-studentAbsen">
                    <i class="fas fa-camera"></i> Absen Mandiri
                </button>
                <button class="nav-tab active" onclick="switchTab('studentRiwayat')" id="tab-student-riwayat">
                    <i class="fas fa-history"></i> Riwayat Absensi Saya
                </button>
                <button class="info-nav-btn" onclick="openProfileModal()">
                    <i class="fas fa-info-circle"></i>
                    <span>Info Developer</span>
                </button>
            </div>
        </header>

        <div class="container">
            <!-- TAB ABSENSI - ADMIN ONLY -->
            <div id="content-absensi" class="tab-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card" onclick="showDetailStats('hadir')">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalStudents">0</h3>
                            <p>Total Siswa Hadir</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showDetailStats('time')">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="lastScan">--:--</h3>
                            <p>Scan Terakhir</p>
                        </div>
                    </div>
                    <div class="stat-card" onclick="showDetailStats('day')">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="currentDay">-</h3>
                            <p>Hari Ini</p>
                        </div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="main-grid">
                    <!-- Scanner Section -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-camera"></i>
                                Scanner Barcode
                            </h2>
                            <button class="btn btn-primary" onclick="toggleScanner()" id="toggleBtn">
                                <i class="fas fa-power-off"></i> Mulai
                            </button>
                        </div>
                        
                        <div class="scanner-container" id="scannerContainer" style="display: none;">
                            <div id="reader"></div>
                            <div class="scanner-overlay">
                                <div class="scanner-line"></div>
                            </div>
                        </div>
                        
                        <div class="scanner-status" id="scannerStatus">
                            <i class="fas fa-info-circle"></i>
                            <span>Klik "Mulai" untuk aktifkan scanner</span>
                        </div>

                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--gray-100);">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-dark);">
                                <i class="fas fa-keyboard"></i> Input Manual
                            </h4>
                            <div class="manual-input">
                                <div class="input-group">
                                    <i class="fas fa-barcode"></i>
                                    <input type="text" id="manualBarcode" placeholder="Masukkan nomor barcode..." 
                                           onkeypress="if(event.key==='Enter')processManualInput()">
                                </div>
                                <button class="btn btn-primary" onclick="processManualInput()">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Quick Add Status Buttons -->
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--gray-100);">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-dark);">
                                <i class="fas fa-plus-circle"></i> Tambah Status Manual
                            </h4>
                            <div class="quick-add-btns">
                                <button class="btn btn-success" onclick="openQuickAddModal('hadir')">
                                    <i class="fas fa-check"></i> Hadir
                                </button>
                                <button class="btn btn-danger" onclick="openQuickAddModal('bolos')">
                                    <i class="fas fa-user-slash"></i> Bolos
                                </button>
                                <button class="btn btn-purple" onclick="openQuickAddModal('izin')">
                                    <i class="fas fa-envelope"></i> Izin
                                </button>
                                <button class="btn btn-orange" onclick="openQuickAddModal('sakit')">
                                    <i class="fas fa-notes-medical"></i> Sakit
                                </button>
                            </div>
                        </div>

                        <!-- Sample Barcodes - Hanya 2 siswa -->
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem; color: var(--primary-dark); font-size: 0.9rem;">
                                <i class="fas fa-tags"></i> Contoh Barcode untuk Testing:
                            </h4>
                            <div class="barcode-samples">
                                <div class="barcode-item" onclick="fillManual('RPL1009')">
                                    <div class="barcode-visual"></div>
                                    <div class="barcode-number">RPL1009</div>
                                    <small>Kania Putri Dewi</small>
                                </div>
                                <div class="barcode-item" onclick="fillManual('RPL2013')">
                                    <div class="barcode-visual"></div>
                                    <div class="barcode-number">RPL2013</div>
                                    <small>Padli Nurramadhan</small>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem; text-align: center;">
                                Klik barcode di atas untuk auto-fill atau scan dengan kamera
                            </p>
                        </div>
                    </div>

                    <!-- Data Table Section -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-list-alt"></i>
                                Data Absensi Hari Ini
                            </h2>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-success" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                                <button class="btn btn-danger" onclick="clearAllData()">
                                    <i class="fas fa-trash"></i> Reset
                                </button>
                            </div>
                        </div>

                        <div class="action-bar">
                            <button class="btn btn-primary" onclick="openModal()">
                                <i class="fas fa-plus"></i> Tambah Manual
                            </button>
                            <button class="btn btn-warning" onclick="loadSampleData()">
                                <i class="fas fa-database"></i> Data Sample
                            </button>
                        </div>

                        <div class="table-container">
                            <table id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama Siswa</th>
                                        <th>Kelas</th>
                                        <th>Jurusan</th>
                                        <th>Waktu Hadir</th>
                                        <th>Status</th>
                                        <th>Waktu Bolos</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <tr class="empty-state">
                                        <td colspan="8">
                                            <i class="fas fa-inbox"></i>
                                            <p>Belum ada data absensi</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB ANALYTICS - ADMIN ONLY -->
            <div id="content-analytics" class="tab-content hidden">
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-line"></i>
                            Dashboard Analytics
                        </h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="analyticsRange" class="btn btn-secondary" onchange="loadAnalytics()">
                                <option value="7">7 Hari Terakhir</option>
                                <option value="30">30 Hari Terakhir</option>
                                <option value="90">3 Bulan Terakhir</option>
                            </select>
                            <button class="btn btn-primary" onclick="loadAnalytics()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="analytics-summary" id="analyticsSummary">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <div class="analytics-grid">
                    <!-- Attendance Trend Chart -->
                    <div class="analytics-card">
                        <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
                            <h3 class="card-title" style="font-size: 1.1rem;">
                                <i class="fas fa-chart-area"></i> Tren Kehadiran
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="attendanceTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- Status Distribution Chart -->
                    <div class="analytics-card">
                        <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
                            <h3 class="card-title" style="font-size: 1.1rem;">
                                <i class="fas fa-chart-pie"></i> Distribusi Status
                            </h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="statusDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Heatmap -->
                    <div class="analytics-card full-width">
                        <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
                            <h3 class="card-title" style="font-size: 1.1rem;">
                                <i class="fas fa-th"></i> Heatmap Kehadiran
                            </h3>
                        </div>
                        <div class="heatmap-container" id="attendanceHeatmap">
                            <!-- Generated by JS -->
                        </div>
                        <div class="heatmap-legend">
                            <div class="heatmap-legend-item">
                                <div class="heatmap-legend-color" style="background: #fee2e2;"></div>
                                <span>Bolos (>50%)</span>
                            </div>
                            <div class="heatmap-legend-item">
                                <div class="heatmap-legend-color" style="background: #fef3c7;"></div>
                                <span>Risk (25-50%)</span>
                            </div>
                            <div class="heatmap-legend-item">
                                <div class="heatmap-legend-color" style="background: #d1fae5;"></div>
                                <span>Good (75-100%)</span>
                            </div>
                            <div class="heatmap-legend-item">
                                <div class="heatmap-legend-color" style="background: #10b981;"></div>
                                <span>Excellent (100%)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Prediction -->
                    <div class="analytics-card full-width">
                        <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
                            <h3 class="card-title" style="font-size: 1.1rem;">
                                <i class="fas fa-exclamation-triangle"></i> Prediksi Siswa Berisiko
                            </h3>
                        </div>
                        <div class="prediction-list" id="riskPredictionList">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB BACKUP & RESTORE - ADMIN ONLY -->
            <div id="content-backup" class="tab-content hidden">
                <div class="backup-section">
                    <div class="card-header" style="border-bottom: 2px solid var(--gray-100); margin-bottom: 0;">
                        <h2 class="card-title">
                            <i class="fas fa-database"></i>
                            Backup & Restore Database
                        </h2>
                    </div>
                    <p style="color: #64748b; margin-top: 0.5rem;">
                        Kelola data absensi dengan fitur backup lengkap dengan enkripsi dan restore data.
                    </p>

                    <div class="backup-grid">
                        <!-- Export Backup -->
                        <div class="backup-card">
                            <div class="backup-icon export">
                                <i class="fas fa-file-export"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--primary-dark);">Export Database</h3>
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1rem;">
                                Export seluruh data absensi ke file JSON terenkripsi.
                            </p>
                            <div class="form-group" style="text-align: left;">
                                <label>Password Enkripsi (opsional)</label>
                                <input type="password" id="backupPassword" placeholder="Masukkan password untuk enkripsi">
                            </div>
                            <button class="btn btn-success" onclick="exportDatabase()" style="width: 100%; margin-top: 1rem;">
                                <i class="fas fa-download"></i> Download Backup
                            </button>
                            <div class="progress-bar" id="exportProgress">
                                <div class="progress-fill" id="exportProgressFill" style="width: 0%;"></div>
                            </div>
                        </div>

                        <!-- Import Backup -->
                        <div class="backup-card">
                            <div class="backup-icon import">
                                <i class="fas fa-file-import"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--primary-dark);">Import Database</h3>
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1rem;">
                                Restore data dari file backup JSON.
                            </p>
                            <div class="form-group" style="text-align: left;">
                                <label>Password Dekripsi (jika ada)</label>
                                <input type="password" id="restorePassword" placeholder="Masukkan password jika file terenkripsi">
                            </div>
                            <div class="file-input-wrapper" style="margin-top: 1rem;">
                                <input type="file" id="backupFileInput" accept=".json,.enc" onchange="handleBackupFileSelect(event)">
                                <label for="backupFileInput" class="file-input-label" id="backupFileLabel">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem; display: block;"></i>
                                    <span id="backupFileText">Klik untuk pilih file backup</span>
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="importDatabase()" style="width: 100%; margin-top: 1rem;">
                                <i class="fas fa-upload"></i> Restore Data
                            </button>
                            <div class="progress-bar" id="importProgress">
                                <div class="progress-fill" id="importProgressFill" style="width: 0%;"></div>
                            </div>
                        </div>

                        <!-- Auto Backup Settings -->
                        <div class="backup-card">
                            <div class="backup-icon encrypt">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3 style="margin-bottom: 0.5rem; color: var(--primary-dark);">Auto Backup</h3>
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1rem;">
                                Backup otomatis ke local storage setiap hari.
                            </p>
                            <div style="text-align: left; margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="autoBackupEnabled" onchange="toggleAutoBackup()">
                                    <span>Aktifkan Auto Backup</span>
                                </label>
                            </div>
                            <div id="lastBackupInfo" style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">
                                Backup terakhir: <span id="lastBackupDate">-</span>
                            </div>
                            <button class="btn btn-secondary" onclick="backupToLocalStorage()" style="width: 100%;">
                                <i class="fas fa-save"></i> Backup Sekarang
                            </button>
                        </div>
                    </div>

                    <!-- Backup History -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 1.1rem;">
                                <i class="fas fa-history"></i> Riwayat Backup
                            </h3>
                            <button class="btn btn-danger btn-small" onclick="clearBackupHistory()">
                                <i class="fas fa-trash"></i> Hapus Riwayat
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="backupHistoryTable">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Ukuran</th>
                                        <th>Tipe</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="backupHistoryBody">
                                    <tr class="empty-state">
                                        <td colspan="4">
                                            <i class="fas fa-inbox"></i>
                                            <p>Belum ada riwayat backup</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB REKAP BULANAN - ADMIN ONLY -->
            <div id="content-rekap" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            Rekap Absensi Bulanan
                        </h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="rekapBulan" class="btn btn-secondary" onchange="loadRekapBulanan()">
                                <option value="0">Januari</option>
                                <option value="1">Februari</option>
                                <option value="2">Maret</option>
                                <option value="3">April</option>
                                <option value="4">Mei</option>
                                <option value="5">Juni</option>
                                <option value="6">Juli</option>
                                <option value="7">Agustus</option>
                                <option value="8">September</option>
                                <option value="9">Oktober</option>
                                <option value="10">November</option>
                                <option value="11">Desember</option>
                            </select>
                            <select id="rekapTahun" class="btn btn-secondary" onchange="loadRekapBulanan()">
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                            <button class="btn btn-success" onclick="exportRekapToExcel()">
                                <i class="fas fa-file-excel"></i> Export
                            </button>
                        </div>
                    </div>

                    <div class="rekap-container" id="rekapContainer">
                        <!-- Generated by JS -->
                    </div>

                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-trophy"></i>
                                Ranking Kehadiran Terbaik
                            </h2>
                        </div>
                        <div class="table-container">
                            <table id="rankingTable">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Nama Siswa</th>
                                        <th>Kelas</th>
                                        <th>Hadir</th>
                                        <th>Izin</th>
                                        <th>Sakit</th>
                                        <th>Bolos</th>
                                        <th>Persentase</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingBody">
                                    <!-- Generated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB RIWAYAT SISWA - ADMIN ONLY -->
            <div id="content-riwayat" class="tab-content hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-history"></i>
                            Riwayat Absensi per Siswa
                        </h2>
                    </div>

                    <div class="riwayat-search">
                        <div class="input-group" style="flex: 1;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="riwayatSearch" placeholder="Cari nama siswa atau barcode..." 
                                   onkeypress="if(event.key==='Enter')searchRiwayat()">
                        </div>
                        <button class="btn btn-primary" onclick="searchRiwayat()">
                            <i class="fas fa-search"></i> Cari
                        </button>
                    </div>

                    <div id="riwayatResult" class="hidden">
                        <!-- Generated by JS -->
                    </div>

                    <div id="riwayatEmpty" class="empty-state">
                        <i class="fas fa-user-clock"></i>
                        <p>Masukkan nama atau barcode siswa untuk melihat riwayat</p>
                    </div>
                </div>
            </div>

            <!-- TAB GENERATOR BARCODE - ADMIN ONLY -->
            <div id="content-generator" class="tab-content hidden">
                <div class="generator-grid">
                    <!-- Form Generator -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-barcode"></i>
                                Generator Barcode
                            </h2>
                        </div>

                        <div class="form-group">
                            <label>Nomor Barcode (ID Siswa)</label>
                            <input type="text" id="genBarcode" placeholder="Contoh: RPL1009" oninput="previewBarcode()">
                        </div>

                        <div class="form-group">
                            <label>Nama Siswa</label>
                            <input type="text" id="genName" placeholder="Nama lengkap siswa">
                        </div>

                        <div class="form-group">
                            <label>Kelas</label>
                            <select id="genClass">
                                <option value="XII">XII</option>
                                <option value="XI">XI</option>
                                <option value="X">X</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Jurusan</label>
                            <input type="text" id="genMajor" value="RPL">
                        </div>

                        <div class="form-group">
                            <label>Format Barcode</label>
                            <div class="format-options">
                                <button class="format-btn active" onclick="setFormat('CODE128')">CODE128</button>
                                <button class="format-btn" onclick="setFormat('CODE39')">CODE39</button>
                                <button class="format-btn" onclick="setFormat('EAN13')">EAN13</button>
                                <button class="format-btn" onclick="setFormat('UPC')">UPC</button>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="generateBarcode()" style="width: 100%; margin-bottom: 0.5rem;">
                                <i class="fas fa-sync-alt"></i> Generate Barcode
                            </button>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-success" onclick="downloadBarcode()" style="flex: 1;">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button class="btn btn-secondary" onclick="printBarcode()" style="flex: 1;">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>

                        <div class="bulk-actions">
                            <button class="btn btn-warning btn-small" onclick="generateAllBarcodes()">
                                <i class="fas fa-magic"></i> Generate Semua Siswa
                            </button>
                            <button class="btn btn-primary btn-small" onclick="downloadAllBarcodes()">
                                <i class="fas fa-file-archive"></i> Download All
                            </button>
                        </div>
                    </div>

                    <!-- Preview & List -->
                    <div>
                        <!-- Preview -->
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <h2 class="card-title">
                                    <i class="fas fa-eye"></i>
                                    Preview
                                </h2>
                            </div>
                            <div class="barcode-preview" id="previewContainer">
                                <i class="fas fa-barcode" style="font-size: 4rem; color: var(--gray-200);"></i>
                                <p style="color: #94a3b8; margin-top: 1rem;">Masukkan data untuk generate barcode</p>
                            </div>
                            <canvas id="barcodeCanvas" style="display: none;"></canvas>
                        </div>

                        <!-- Generated List -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">
                                    <i class="fas fa-list"></i>
                                    Barcode Generated (<span id="generatedCount">0</span>)
                                </h2>
                                <button class="btn btn-danger btn-small" onclick="clearGenerated()">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                            <div class="student-list" id="generatedList">
                                <div class="empty-state" style="padding: 2rem;">
                                    <i class="fas fa-inbox"></i>
                                    <p>Belum ada barcode yang digenerate</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB ABSEN MANDIRI - STUDENT ONLY -->
            <div id="content-studentAbsen" class="tab-content hidden">
                <div class="card">
                    <div class="student-self-banner">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <h3>Absen Mandiri Siswa</h3>
                            <p>Scan barcode atau masukkan nomor barcode Anda untuk melakukan absensi. Lokasi Anda akan direkam secara otomatis.</p>
                        </div>
                    </div>

                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-camera"></i>
                            Scanner Barcode Mandiri
                        </h2>
                    </div>

                    <!-- Scanner for student -->
                    <div class="scanner-container" id="studentScannerContainer" style="display: none;">
                        <div id="studentReader"></div>
                        <div class="scanner-overlay">
                            <div class="scanner-line"></div>
                        </div>
                    </div>

                    <div class="scanner-status" id="studentScannerStatus">
                        <i class="fas fa-info-circle"></i>
                        <span>Klik "Mulai Scanner" untuk aktifkan kamera</span>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="toggleStudentScanner()" id="studentToggleBtn">
                            <i class="fas fa-power-off"></i> Mulai Scanner
                        </button>
                    </div>

                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--gray-100);">
                        <h4 style="margin-bottom: 1rem; color: var(--primary-dark);">
                            <i class="fas fa-keyboard"></i> Input Manual
                        </h4>
                        <div class="manual-input">
                            <div class="input-group">
                                <i class="fas fa-barcode"></i>
                                <input type="text" id="studentManualBarcode" placeholder="Masukkan nomor barcode Anda..." 
                                       value="">
                            </div>
                            <button class="btn btn-primary" onclick="processStudentSelfAttendance()">
                                <i class="fas fa-check"></i> Absen Sekarang
                            </button>
                        </div>
                    </div>

                    <div id="locationStatus" class="location-status location-warning">
                        <i class="fas fa-spinner fa-spin"></i> Mendeteksi lokasi...
                    </div>

                    <div style="margin-top: 1rem; font-size: 0.9rem; color: #64748b;">
                        <i class="fas fa-lock"></i> Lokasi Anda hanya digunakan untuk validasi dan tidak akan ditampilkan.
                    </div>
                </div>
            </div>

            <!-- TAB RIWAYAT SISWA - STUDENT ONLY (View Only) -->
            <div id="content-studentRiwayat" class="tab-content hidden">
                <div class="card">
                    <div class="student-view-banner">
                        <i class="fas fa-user-graduate"></i>
                        <div>
                            <h3>Mode Tampilan Siswa</h3>
                            <p>Anda hanya dapat melihat riwayat absensi sendiri. Tidak dapat menambah atau mengubah data.</p>
                        </div>
                    </div>

                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-history"></i>
                            Riwayat Absensi Saya
                        </h2>
                    </div>

                    <div id="studentRiwayatContent">
                        <!-- Generated by JS - akan diisi oleh loadStudentOwnRiwayat() -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Tambah Manual -->
        <div class="modal" id="addModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-plus"></i> Tambah Absensi Manual</h2>
                </div>
                <form id="addForm" onsubmit="saveManualEntry(event)">
                    <div class="form-group">
                        <label>Nomor Barcode</label>
                        <input type="text" id="modalBarcode" required placeholder="Contoh: RPL005">
                    </div>
                    <div class="form-group">
                        <label>Nama Siswa</label>
                        <input type="text" id="modalName" required placeholder="Nama lengkap siswa">
                    </div>
                    <div class="form-group">
                        <label>Kelas</label>
                        <select id="modalClass" required>
                            <option value="XII">XII</option>
                            <option value="XI">XI</option>
                            <option value="X">X</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jurusan</label>
                        <input type="text" id="modalMajor" value="RPL" required>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="modalStatus" required>
                            <option value="hadir">Hadir</option>
                            <option value="bolos">Bolos</option>
                            <option value="izin">Izin</option>
                            <option value="sakit">Sakit</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="closeModal()" style="background: var(--gray-200); color: var(--gray-700);">
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Quick Add -->
        <div class="modal" id="quickAddModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-plus"></i> Tambah Status <span id="quickAddStatusTitle"></span></h2>
                </div>
                <form id="quickAddForm" onsubmit="saveQuickAdd(event)">
                    <div class="form-group">
                        <label>Nomor Barcode</label>
                        <input type="text" id="quickBarcode" required placeholder="Contoh: RPL1009">
                    </div>
                    <div class="form-group">
                        <label>Nama Siswa (Otomatis terisi jika terdaftar)</label>
                        <input type="text" id="quickName" placeholder="Nama lengkap siswa">
                    </div>
                    <div class="form-group">
                        <label>Kelas</label>
                        <select id="quickClass">
                            <option value="XII">XII</option>
                            <option value="XI">XI</option>
                            <option value="X">X</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jurusan</label>
                        <input type="text" id="quickMajor" value="RPL">
                    </div>
                    <input type="hidden" id="quickStatus" value="">
                    <div class="modal-footer">
                        <button type="button" class="btn" onclick="closeQuickAddModal()" style="background: var(--gray-200); color: var(--gray-700);">
                            Batal
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Bolos -->
        <div class="modal" id="bolosModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-slash"></i> Konfirmasi Bolos</h2>
                </div>
                <div class="form-group">
                    <p>Apakah Anda yakin ingin menandai siswa ini sebagai <strong>Bolos</strong>?</p>
                    <p style="margin-top: 1rem; color: #64748b;">
                        <i class="fas fa-info-circle"></i> 
                        Siswa yang sudah ditandai bolos akan dicatat waktu bolosnya dan statusnya akan berubah di Excel.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeBolosModal()" style="background: var(--gray-200); color: var(--gray-700);">
                        Batal
                    </button>
                    <button type="button" class="btn btn-warning" onclick="confirmBolos()">
                        <i class="fas fa-check"></i> Ya, Tandai Bolos
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Status Change -->
        <div class="modal" id="statusModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-exchange-alt"></i> Ubah Status Siswa</h2>
                </div>
                <div class="form-group">
                    <p>Pilih status baru untuk siswa ini:</p>
                    <div class="status-options">
                        <div class="status-option hadir" onclick="selectStatus('hadir')">
                            <i class="fas fa-check-circle"></i>
                            <div>Hadir</div>
                        </div>
                        <div class="status-option bolos" onclick="selectStatus('bolos')">
                            <i class="fas fa-user-slash"></i>
                            <div>Bolos</div>
                        </div>
                        <div class="status-option izin" onclick="selectStatus('izin')">
                            <i class="fas fa-envelope"></i>
                            <div>Izin</div>
                        </div>
                        <div class="status-option sakit" onclick="selectStatus('sakit')">
                            <i class="fas fa-notes-medical"></i>
                            <div>Sakit</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeStatusModal()" style="background: var(--gray-200); color: var(--gray-700);">
                        Batal
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmStatusChange()">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>

        <!-- Print Area -->
        <div class="print-area" id="printArea"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURASI FIREBASE - GANTI DENGAN KONFIGURASI ANDA
        // ============================================
        const firebaseConfig = {
  apiKey: "AIzaSyBaduikE7jLXAqJTGsV5J0Gjtrd02XtIDw",
  authDomain: "absensi-12rpl.firebaseapp.com",
  databaseURL: "https://absensi-12rpl-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "absensi-12rpl",
  storageBucket: "absensi-12rpl.appspot.com",
  messagingSenderId: "300232000589",
  appId: "1:300232000589:web:d8a449eef5d225c05a4804",
  measurementId: "G-X5JZ3MKHTJ"
};

        // Database Setup (IndexedDB + Firebase)
        let db;
        let firebaseApp;
        let firebaseDB;
        const DB_NAME = 'AbsensiDB';
        const DB_VERSION = 9; // Upgraded for fingerprint, audit, sync queue
        let html5QrCode;
        let studentHtml5QrCode; // Scanner untuk siswa
        let isScanning = false;
        let isStudentScanning = false;
        let currentDate = new Date();
        let currentFormat = 'CODE128';
        let generatedBarcodes = [];
        let currentBolosId = null;
        let currentStatusId = null;
        let selectedNewStatus = null;
        let currentQuickStatus = null;
        let currentUser = null;
        let isStudentMode = false;
        let currentStudentBarcode = null;
        let isOnline = false;
        let syncListener = null;
        let lastCheckedDate = null;
        let deferredPrompt = null; // For PWA install
        let chatListener = null; // For chat messages
        let unreadMessages = 0; // Count unread messages

        // Chart instances
        let attendanceTrendChart = null;
        let statusDistributionChart = null;

        // Admin credentials - UPDATED with admin2
        const ADMIN_USERS = [
            { username: 'admin', password: 'admin123', name: 'Administrator' },
            { username: 'admin2', password: 'admin456', name: 'Administrator 2' },
            { username: 'guru1', password: 'guru123', name: 'Guru BK' },
            { username: 'guru2', password: 'guru456', name: 'Wali Kelas' }
        ];

        // Student passwords
        const STUDENT_PASSWORDS = {
            'RPL1001': '01052006', 'RPL1002': '01052006', 'RPL1003': '01052006', 'RPL1004': '01052006',
            'RPL1005': '01052006', 'RPL1006': '01052006', 'RPL1007': '01052006', 'RPL1008': '01052006',
            'RPL1009': '01052006', 'RPL1010': '01052006', 'RPL1011': '01052006', 'RPL1012': '01052006',
            'RPL1013': '01052006', 'RPL1014': '01052006', 'RPL1015': '01052006', 'RPL1016': '01052006',
            'RPL1017': '01052006', 'RPL2001': '01052006', 'RPL2002': '01052006', 'RPL2003': '01052006',
            'RPL2004': '01052006', 'RPL2005': '01052006', 'RPL2006': '01052006', 'RPL2007': '01052006',
            'RPL2008': '01052006', 'RPL2009': '01052006', 'RPL2010': '01052006', 'RPL2011': '01052006',
            'RPL2012': '01052006', 'RPL2013': '01052006', 'RPL2014': '01052006', 'RPL2015': '01052006',
            'RPL2016': '01052006', 'RPL2017': '01052006', 'RPL2018': '01052006', 'RPL2019': '01052006',
            'RPL2020': '01052006', 'RPL2021': '01052006', 'RPL2022': '01052006', 'RPL2023': '01052006',
            'RPL2024': '01052006', 'RPL2025': '01052006', 'RPL2026': '01052006'
        };

        // Guru WhatsApp number
        const GURU_WHATSAPP = '62895421221988';

        // Sample Data Siswa
        const studentDatabase = {
            'RPL1001': { name: 'Ade Pajriah', class: 'XII', major: 'RPL' },
            'RPL1002': { name: 'Aisah', class: 'XII', major: 'RPL' },
            'RPL1003': { name: 'Anggun Mega Aini', class: 'XII', major: 'RPL' },
            'RPL1004': { name: 'Artika Sari Devi', class: 'XII', major: 'RPL' },
            'RPL1005': { name: 'Atikah', class: 'XII', major: 'RPL' },
            'RPL1006': { name: 'Azizah Kamizah', class: 'XII', major: 'RPL' },
            'RPL1007': { name: 'Indri Nuriska', class: 'XII', major: 'RPL' },
            'RPL1008': { name: 'Kaila Pratiwi', class: 'XII', major: 'RPL' },
            'RPL1009': { name: 'Kania Putri Dewi', class: 'XII', major: 'RPL' },
            'RPL1010': { name: 'Nopi Yanti', class: 'XII', major: 'RPL' },
            'RPL1011': { name: 'Nurul Sa\'adah', class: 'XII', major: 'RPL' },
            'RPL1012': { name: 'Ovi Nurmaniyah', class: 'XII', major: 'RPL' },
            'RPL1013': { name: 'Putri Damayanti', class: 'XII', major: 'RPL' },
            'RPL1014': { name: 'Rani Anggraeni', class: 'XII', major: 'RPL' },
            'RPL1015': { name: 'Selli Repina', class: 'XII', major: 'RPL' },
            'RPL1016': { name: 'Siti Aminah', class: 'XII', major: 'RPL' },
            'RPL1017': { name: 'Syafa Aqilah', class: 'XII', major: 'RPL' },
            'RPL2001': { name: 'Ade Amelia Rizkiyah', class: 'XII', major: 'RPL' },
            'RPL2002': { name: 'Badrussalam', class: 'XII', major: 'RPL' },
            'RPL2003': { name: 'Chelsi Kirani', class: 'XII', major: 'RPL' },
            'RPL2004': { name: 'Eka Maulana Utomo', class: 'XII', major: 'RPL' },
            'RPL2005': { name: 'Imbron Rosadi', class: 'XII', major: 'RPL' },
            'RPL2006': { name: 'Irnasih', class: 'XII', major: 'RPL' },
            'RPL2007': { name: 'Jeje Latipah', class: 'XII', major: 'RPL' },
            'RPL2008': { name: 'Meli', class: 'XII', major: 'RPL' },
            'RPL2009': { name: 'Muhamad Jalil', class: 'XII', major: 'RPL' },
            'RPL2010': { name: 'Neman Maian', class: 'XII', major: 'RPL' },
            'RPL2011': { name: 'Neng Sari', class: 'XII', major: 'RPL' },
            'RPL2012': { name: 'Nurjaya', class: 'XII', major: 'RPL' },
            'RPL2013': { name: 'Padli Nurramadhan', class: 'XII', major: 'RPL' },
            'RPL2014': { name: 'Fazri Ramdani', class: 'XII', major: 'RPL' },
            'RPL2015': { name: 'Putri Cahyati', class: 'XII', major: 'RPL' },
            'RPL2016': { name: 'Rizky Febrian', class: 'XII', major: 'RPL' },
            'RPL2017': { name: 'Suci Siti Aisyah', class: 'XII', major: 'RPL' },
            'RPL2018': { name: 'Sutomo Azis', class: 'XII', major: 'RPL' },
            'RPL2019': { name: 'Tarsyidik', class: 'XII', major: 'RPL' },
            'RPL2020': { name: 'Widia', class: 'XII', major: 'RPL' },
            'RPL2021': { name: 'Muhamad Zulfikar', class: 'XII', major: 'RPL' },
            'RPL2022': { name: 'Eka Ramdani', class: 'XII', major: 'RPL' },
            'RPL2023': { name: 'Anida Khoirunisa', class: 'XII', major: 'RPL' },
            'RPL2024': { name: 'Muhamad Jujun Junaedi', class: 'XII', major: 'RPL' },
            'RPL2025': { name: 'Amelia', class: 'XII', major: 'RPL' },
            'RPL2026': { name: 'Permana Kusuma', class: 'XII', major: 'RPL' },
        };

       // ============================================
// KONFIGURASI AREA SEKOLAH
// ============================================
const SCHOOL_LOCATION = {
    lat: -6.066,      // Lintang (latitude) sekolah
    lng: 107.2313,    // Bujur (longitude) sekolah
    radius: 100       // Radius area sekolah dalam meter (sesuaikan jika perlu)
};

        // ============================================
        // FUNGSI AUDIT TRAIL
        // ============================================
        function addAuditLog(action, details, user = null, userType = null, syncStatus = 'pending') {
            if (!db) return;

            const log = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                user: user || (currentUser ? currentUser.name : (currentStudentBarcode ? studentDatabase[currentStudentBarcode]?.name : 'Unknown')),
                userType: userType || (isStudentMode ? 'siswa' : 'admin'),
                syncStatus: syncStatus
            };

            const transaction = db.transaction(['auditLog'], 'readwrite');
            const store = transaction.objectStore('auditLog');
            store.add(log);

            // Jika online, langsung sync ke Firebase (optional)
            if (firebaseDB && isOnline) {
                firebaseDB.ref('auditLog').push(log);
            } else {
                // Simpan ke antrian sinkronisasi
                addToSyncQueue('audit', log);
            }
        }

        // ============================================
        // FUNGSI SYNC QUEUE
        // ============================================
        function addToSyncQueue(type, data) {
            if (!db) return;

            const queueItem = {
                type: type,
                data: data,
                timestamp: new Date().toISOString(),
                retryCount: 0
            };

            const transaction = db.transaction(['syncQueue'], 'readwrite');
            const store = transaction.objectStore('syncQueue');
            store.add(queueItem);

            // Update badge jika perlu
            updateSyncQueueBadge();
        }

        function updateSyncQueueBadge() {
            if (!db) return;

            const transaction = db.transaction(['syncQueue'], 'readonly');
            const store = transaction.objectStore('syncQueue');
            const countRequest = store.count();

            countRequest.onsuccess = () => {
                const count = countRequest.result;
                // Tampilkan badge di suatu tempat (misal di sync status)
                if (count > 0) {
                    document.getElementById('syncStatus').classList.add('has-queue');
                    // Bisa tambahkan tooltip
                } else {
                    document.getElementById('syncStatus').classList.remove('has-queue');
                }
            };
        }

        function processSyncQueue() {
            if (!db || !isOnline) return;

            const transaction = db.transaction(['syncQueue'], 'readonly');
            const store = transaction.objectStore('syncQueue');
            const request = store.getAll();

            request.onsuccess = () => {
                const queue = request.result;
                if (queue.length === 0) return;

                queue.forEach(item => {
                    if (item.type === 'audit' && firebaseDB) {
                        firebaseDB.ref('auditLog').push(item.data)
                            .then(() => {
                                // Hapus dari queue
                                const deleteTx = db.transaction(['syncQueue'], 'readwrite');
                                const deleteStore = deleteTx.objectStore('syncQueue');
                                deleteStore.delete(item.id);
                            })
                            .catch(err => {
                                console.error('Sync queue error:', err);
                            });
                    }
                    // Tambah tipe lain jika perlu
                });
            };
        }

        // ============================================
        // FUNGSI VALIDASI LOKASI (DIAM-DIAM)
        // ============================================
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung'));
                } else {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            resolve({
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude,
                                accuracy: pos.coords.accuracy
                            });
                        },
                        (err) => {
                            reject(err);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                }
            });
        }

        function isWithinSchool(location) {
            const R = 6371e3; // radius bumi dalam meter
            const 1 = location.lat * Math.PI/180;
            const 2 = SCHOOL_LOCATION.lat * Math.PI/180;
            const  = (SCHOOL_LOCATION.lat - location.lat) * Math.PI/180;
            const  = (SCHOOL_LOCATION.lng - location.lng) * Math.PI/180;

            const a = Math.sin(/2) * Math.sin(/2) +
                    Math.cos(1) * Math.cos(2) *
                    Math.sin(/2) * Math.sin(/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            const distance = R * c;
            return distance <= SCHOOL_LOCATION.radius;
        }

        // ============================================
        // FUNGSI ABSEN MANDIRI SISWA (MODIFIKASI)
        // ============================================
        function toggleStudentScanner() {
            if (isStudentScanning) {
                stopStudentScanner();
            } else {
                startStudentScanner();
            }
        }

        function startStudentScanner() {
            const container = document.getElementById('studentScannerContainer');
            const status = document.getElementById('studentScannerStatus');
            const btn = document.getElementById('studentToggleBtn');

            container.style.display = 'block';
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memulai kamera...';
            status.classList.add('scanning');

            studentHtml5QrCode = new Html5Qrcode("studentReader");

            studentHtml5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onStudentScanSuccess,
                onStudentScanFailure
            ).then(() => {
                isStudentScanning = true;
                btn.innerHTML = '<i class="fas fa-stop"></i> Berhenti';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');
                status.innerHTML = '<i class="fas fa-camera"></i> Arahkan barcode ke kamera';
            }).catch(err => {
                status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error: ' + err;
                status.classList.remove('scanning');
                container.style.display = 'none';
                showToast('Gagal mengakses kamera: ' + err, 'error');
            });
        }

        function stopStudentScanner() {
            if (studentHtml5QrCode) {
                studentHtml5QrCode.stop().then(() => {
                    isStudentScanning = false;
                    document.getElementById('studentScannerContainer').style.display = 'none';
                    document.getElementById('studentScannerStatus').innerHTML = '<i class="fas fa-info-circle"></i> Scanner dihentikan';
                    document.getElementById('studentScannerStatus').classList.remove('scanning');
                    document.getElementById('studentToggleBtn').innerHTML = '<i class="fas fa-power-off"></i> Mulai Scanner';
                    document.getElementById('studentToggleBtn').classList.remove('btn-danger');
                    document.getElementById('studentToggleBtn').classList.add('btn-primary');
                });
            }
        }

        function onStudentScanSuccess(decodedText, decodedResult) {
            if (decodedText) {
                // Auto-fill input
                document.getElementById('studentManualBarcode').value = decodedText;
                // Proses absen
                processStudentSelfAttendance();
            }
        }

        function onStudentScanFailure(error) {
            // Abaikan
        }

        // ============================================
        // FUNGSI ABSEN MANDIRI SISWA (MODIFIKASI)
        // ============================================
        function processStudentSelfAttendance() {
            const barcodeInput = document.getElementById('studentManualBarcode');
            const barcode = barcodeInput.value.trim().toUpperCase();

            if (!barcode) {
                showToast('Masukkan barcode Anda!', 'error');
                return;
            }

            // Cek apakah barcode sesuai dengan siswa yang login
            if (barcode !== currentStudentBarcode) {
                showToast('Anda hanya dapat melakukan absen untuk diri sendiri!', 'error');
                return;
            }

            const student = studentDatabase[barcode];
            if (!student) {
                showToast('Data siswa tidak ditemukan!', 'error');
                return;
            }

            // Cek apakah sudah absen hari ini
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(getTodayString());

            request.onsuccess = async () => {
                const todayData = request.result || [];
                const existing = todayData.find(item => item.barcode === barcode);

                if (existing) {
                    showToast(`Anda sudah absen hari ini!`, 'warning');
                    return;
                }

                // Tampilkan status lokasi (loading)
                const locationStatus = document.getElementById('locationStatus');
                locationStatus.className = 'location-status location-warning';
                locationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memverifikasi lokasi...';

                try {
                    // Ambil lokasi (diam-diam)
                    const location = await getCurrentLocation();

                    // Validasi area sekolah
                    const withinSchool = isWithinSchool(location);

                    // MODIFIKASI: Jika di luar sekolah, tetap catat sebagai bolos (tapi tampilkan sukses)
                    let statusToSave = 'hadir';
                    if (!withinSchool) {
                        statusToSave = 'bolos'; // Catat sebagai bolos
                        // Tampilkan pesan tetap sukses (siswa tidak tahu)
                        locationStatus.className = 'location-status location-valid'; // Ubah tampilan jadi hijau (seolah sukses)
                        locationStatus.innerHTML = '<i class="fas fa-check-circle"></i> Lokasi valid. Absen berhasil!';
                        // Jangan tampilkan error
                    } else {
                        locationStatus.className = 'location-status location-valid';
                        locationStatus.innerHTML = '<i class="fas fa-check-circle"></i> Lokasi valid. Absen berhasil!';
                    }

                    // Tambahkan data absensi dengan status yang sudah ditentukan
                    const now = new Date();
                    const data = {
                        barcode: barcode,
                        name: student.name,
                        class: student.class,
                        major: student.major,
                        date: getTodayString(),
                        time: now.toLocaleTimeString('id-ID'),
                        timestamp: now.getTime(),
                        status: statusToSave, // Hadir jika di dalam sekolah, Bolos jika di luar
                        bolosTime: statusToSave === 'bolos' ? now.toLocaleTimeString('id-ID') : null,
                        keterangan: '',
                        operator: currentStudentBarcode + ' (Siswa)',
                        location: { // Disimpan diam-diam, tidak ditampilkan
                            lat: location.lat,
                            lng: location.lng,
                            accuracy: location.accuracy
                        }
                    };

                    const addTx = db.transaction(['attendance'], 'readwrite');
                    const addStore = addTx.objectStore('attendance');
                    addStore.add(data).onsuccess = (event) => {
                        data.id = event.target.result;
                        loadTodayData(); // Untuk admin, data langsung tampil
                        updateStats();

                        // Broadcast ke Firebase
                        broadcastToFirebase('ADD', data);

                        // Catat audit trail
                        addAuditLog('SISWA_ABSEN_MANDIRI', `Siswa ${student.name} (${barcode}) melakukan absen mandiri. Status tersimpan: ${statusToSave}`);

                        // Tampilkan toast sukses
                        showToast('Absen berhasil!', 'success');

                        // Reset input
                        barcodeInput.value = '';

                        // Matikan scanner jika aktif
                        if (isStudentScanning) {
                            stopStudentScanner();
                        }

                        // Trigger background sync jika ada
                        if ('serviceWorker' in navigator && 'SyncManager' in window) {
                            navigator.serviceWorker.ready.then(registration => {
                                registration.sync.register('sync-attendance');
                            });
                        }

                        // Sembunyikan status lokasi setelah beberapa detik
                        setTimeout(() => {
                            locationStatus.className = 'location-status location-warning';
                            locationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mendeteksi lokasi...';
                        }, 5000);
                    };

                } catch (error) {
                    console.error('Location error:', error);
                    document.getElementById('locationStatus').className = 'location-status location-invalid';
                    document.getElementById('locationStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Gagal mendapatkan lokasi. Pastikan GPS aktif.';
                    showToast('Gagal mendapatkan lokasi. Coba lagi.', 'error');
                }
            };
        }

        // ============================================
        // MODIFIKASI FUNGSI LOGIN UNTUK AUDIT TRAIL
        // ============================================
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = ADMIN_USERS.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                isStudentMode = false;
                localStorage.setItem('currentUser', JSON.stringify(user));
                localStorage.removeItem('currentStudent');
                showMainApp();
                showToast(`Selamat datang, ${user.name}!`, 'success');
                
                // Audit trail
                addAuditLog('LOGIN_ADMIN', `Admin ${user.name} login.`);

                // Request notification permission on login
                if (Notification.permission === 'default') {
                    requestNotificationPermission();
                }
                
                // Check if fingerprint not registered, offer to register
                const existingKeys = JSON.parse(localStorage.getItem('fingerprint_keys') || '{}');
                const userId = getUserId('admin', username);
                if (!existingKeys[userId] && isFingerprintSupported()) {
                    setTimeout(() => {
                        if (confirm('Daftarkan fingerprint untuk login lebih cepat di lain waktu?')) {
                            registerFingerprint('admin', username, user.name);
                        }
                    }, 1000);
                }
            } else {
                showToast('Username atau password salah!', 'error');
            }
        }

        function handleStudentLogin(e) {
            e.preventDefault();
            
            const barcodeInput = document.getElementById('studentBarcode');
            const passwordInput = document.getElementById('studentPassword');
            
            const barcode = barcodeInput.value.trim().toUpperCase();
            const password = passwordInput.value.trim();
            
            if (!studentDatabase[barcode]) {
                showToast('Barcode siswa tidak ditemukan!', 'error');
                return;
            }
            
            if (STUDENT_PASSWORDS[barcode] !== password) {
                showToast('Password (tanggal lahir) salah!', 'error');
                return;
            }
            
            currentStudentBarcode = barcode;
            isStudentMode = true;
            localStorage.setItem('currentStudent', barcode);
            localStorage.removeItem('currentUser');
            
            // Audit trail
            addAuditLog('LOGIN_SISWA', `Siswa ${studentDatabase[barcode].name} (${barcode}) login.`);

            // Matikan listener Firebase untuk siswa (hanya view)
            if (syncListener) {
                syncListener.off();
                syncListener = null;
            }
            
            // Matikan chat listener untuk siswa
            if (chatListener) {
                chatListener.off();
                chatListener = null;
            }
            
            showToast(`Selamat datang, ${studentDatabase[barcode].name}!`, 'success');
            showMainApp();
            
            // Check if fingerprint not registered, offer to register
            const existingKeys = JSON.parse(localStorage.getItem('fingerprint_keys') || '{}');
            const userId = getUserId('student', barcode);
            if (!existingKeys[userId] && isFingerprintSupported()) {
                setTimeout(() => {
                    if (confirm('Daftarkan fingerprint untuk login lebih cepat di lain waktu?')) {
                        registerFingerprint('student', barcode, studentDatabase[barcode].name);
                    }
                }, 1000);
            }
        }

        function handleLogout() {
            if (currentUser) {
                addAuditLog('LOGOUT_ADMIN', `Admin ${currentUser.name} logout.`);
            } else if (currentStudentBarcode) {
                addAuditLog('LOGOUT_SISWA', `Siswa ${studentDatabase[currentStudentBarcode].name} logout.`);
            }

            currentUser = null;
            currentStudentBarcode = null;
            isStudentMode = false;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentStudent');
            
            // Matikan listener
            if (syncListener) {
                syncListener.off();
                syncListener = null;
            }
            
            // Matikan chat listener
            if (chatListener) {
                chatListener.off();
                chatListener = null;
            }
            
            // Reset unread messages
            unreadMessages = 0;
            updateChatBadge();
            
            showLoginPage();
            showToast('Logout berhasil', 'success');
            
            // Reset fingerprint UI
            setTimeout(updateFingerprintUI, 100);
        }

        // Modifikasi fungsi deleteEntry untuk audit trail
        function deleteEntry(id) {
            if (!db || isStudentMode) return;
            
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                // Ambil data dulu untuk keperluan sync
                const getTransaction = db.transaction(['attendance'], 'readonly');
                const getStore = getTransaction.objectStore('attendance');
                const getRequest = getStore.get(id);
                
                getRequest.onsuccess = () => {
                    const dataToDelete = getRequest.result;
                    
                    // Audit trail
                    addAuditLog('DELETE_ABSENSI', `Menghapus data absensi: ${dataToDelete.name} (${dataToDelete.barcode}) dengan status ${dataToDelete.status}`);

                    // Hapus dari IndexedDB
                    const deleteTransaction = db.transaction(['attendance'], 'readwrite');
                    const deleteStore = deleteTransaction.objectStore('attendance');
                    deleteStore.delete(id).onsuccess = () => {
                        loadTodayData();
                        
                        // Broadcast ke Firebase
                        broadcastToFirebase('DELETE', dataToDelete);
                        
                        showToast('Data berhasil dihapus', 'success');
                    };
                };
            }
        }

        // Modifikasi fungsi confirmBolos untuk audit trail
        function confirmBolos() {
            if (!currentBolosId || !db) return;
            
            const transaction = db.transaction(['attendance'], 'readwrite');
            const store = transaction.objectStore('attendance');
            const request = store.get(currentBolosId);
            
            request.onsuccess = () => {
                const data = request.result;
                if (data) {
                    data.status = 'bolos';
                    data.bolosTime = new Date().toLocaleTimeString('id-ID');
                    
                    store.put(data).onsuccess = () => {
                        loadTodayData();
                        
                        // Audit trail
                        addAuditLog('TANDA_BOLOS', `Menandai ${data.name} (${data.barcode}) sebagai bolos.`);

                        // Broadcast ke Firebase
                        broadcastToFirebase('UPDATE', data);
                        
                        notifyGuru('bolos', data.name, data.barcode);
                        showToast(`Siswa ${data.name} ditandai sebagai bolos`, 'warning');
                        closeBolosModal();
                    };
                }
            };
        }

        // Modifikasi fungsi confirmStatusChange untuk audit trail
        function confirmStatusChange() {
            if (!currentStatusId || !selectedNewStatus || !db) {
                showToast('Pilih status terlebih dahulu!', 'error');
                return;
            }
            
            const transaction = db.transaction(['attendance'], 'readwrite');
            const store = transaction.objectStore('attendance');
            const request = store.get(currentStatusId);
            
            request.onsuccess = () => {
                const data = request.result;
                if (data) {
                    const oldStatus = data.status;
                    data.status = selectedNewStatus;
                    
                    if (selectedNewStatus === 'izin' || selectedNewStatus === 'sakit') {
                        data.time = '-';
                        data.bolosTime = null;
                    } else if (selectedNewStatus === 'bolos') {
                        data.bolosTime = new Date().toLocaleTimeString('id-ID');
                    } else if (selectedNewStatus === 'hadir' && (oldStatus === 'izin' || oldStatus === 'sakit')) {
                        data.time = new Date().toLocaleTimeString('id-ID');
                        data.bolosTime = null;
                    }
                    
                    store.put(data).onsuccess = () => {
                        loadTodayData();
                        
                        // Audit trail
                        addAuditLog('UBAH_STATUS', `Mengubah status ${data.name} (${data.barcode}) dari ${oldStatus} menjadi ${selectedNewStatus}.`);

                        // Broadcast ke Firebase
                        broadcastToFirebase('UPDATE', data);
                        
                        if (selectedNewStatus === 'bolos' || selectedNewStatus === 'izin' || selectedNewStatus === 'sakit') {
                            notifyGuru(selectedNewStatus, data.name, data.barcode);
                        }
                        
                        showToast(`Status ${data.name} berhasil diubah menjadi ${selectedNewStatus}`, 'success');
                        closeStatusModal();
                    };
                }
            };
        }

        // Modifikasi fungsi addAttendance untuk audit trail
        function addAttendance(barcode, name, studentClass, major, status = 'hadir') {
            if (!db) return;
            
            const now = new Date();
            const data = {
                barcode: barcode,
                name: name,
                class: studentClass,
                major: major,
                date: getTodayString(),
                time: now.toLocaleTimeString('id-ID'),
                timestamp: now.getTime(),
                status: status,
                bolosTime: null,
                keterangan: '',
                operator: currentUser ? currentUser.name : 'Admin'
            };
            
            if (status === 'izin' || status === 'sakit') {
                data.time = '-';
            }
            
            const transaction = db.transaction(['attendance'], 'readwrite');
            const store = transaction.objectStore('attendance');
            
            store.add(data).onsuccess = (event) => {
                // Simpan ID yang di-generate
                data.id = event.target.result;
                
                loadTodayData();
                updateStats();
                
                // Audit trail
                addAuditLog('TAMBAH_ABSENSI', `Menambahkan absensi: ${name} (${barcode}) dengan status ${status}.`);

                // Broadcast ke Firebase dan localStorage
                broadcastToFirebase('ADD', data);
                
                if (status === 'bolos' || status === 'izin' || status === 'sakit') {
                    notifyGuru(status, name, barcode);
                }
                
                // Trigger background sync if available
                if ('serviceWorker' in navigator && 'SyncManager' in window) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.sync.register('sync-attendance');
                    });
                }
            };
        }

        // ============================================
        // MODIFIKASI INITDB UNTUK MENAMBAHKAN STORE BARU
        // ============================================
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => showToast('Error membuka database', 'error');
            
            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('Database opened successfully');

                // Proses antrian sinkronisasi setelah db siap
                processSyncQueue();
            };
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                
                // Store for daily attendance
                if (!db.objectStoreNames.contains('attendance')) {
                    const store = db.createObjectStore('attendance', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('date', 'date', { unique: false });
                    store.createIndex('barcode', 'barcode', { unique: false });
                }
                
                // Store for general history (all dates)
                if (!db.objectStoreNames.contains('attendanceHistory')) {
                    const historyStore = db.createObjectStore('attendanceHistory', { keyPath: 'id', autoIncrement: true });
                    historyStore.createIndex('historyDate', 'historyDate', { unique: false });
                    historyStore.createIndex('barcode', 'barcode', { unique: false });
                }
                
                // Store for student-specific history
                if (!db.objectStoreNames.contains('studentHistory')) {
                    const studentHistoryStore = db.createObjectStore('studentHistory', { keyPath: 'id', autoIncrement: true });
                    studentHistoryStore.createIndex('barcode', 'barcode', { unique: false });
                    studentHistoryStore.createIndex('date', 'date', { unique: false });
                }

                // Store untuk audit log
                if (!db.objectStoreNames.contains('auditLog')) {
                    const auditStore = db.createObjectStore('auditLog', { keyPath: 'id', autoIncrement: true });
                    auditStore.createIndex('timestamp', 'timestamp', { unique: false });
                    auditStore.createIndex('user', 'user', { unique: false });
                    auditStore.createIndex('userType', 'userType', { unique: false });
                }

                // Store untuk sync queue
                if (!db.objectStoreNames.contains('syncQueue')) {
                    const syncStore = db.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
                    syncStore.createIndex('timestamp', 'timestamp', { unique: false });
                    syncStore.createIndex('type', 'type', { unique: false });
                }
            };
        }

        // ============================================
        // MODIFIKASI HANDLE ONLINE/OFFLINE UNTUK SYNC QUEUE
        // ============================================
        function handleOnline() {
            isOnline = true;
            document.getElementById('offlineIndicator').classList.remove('show');
            updateConnectionStatus('connected', 'Kembali online');
            document.getElementById('syncText').textContent = 'Online';
            document.getElementById('syncStatus').className = 'sync-status online';
            
            // Sync data
            syncLocalToFirebase();
            processSyncQueue(); // Proses antrian
            showToast('Koneksi internet tersambung. Menyinkronkan data...', 'success');
            
            // Restart chat listener if modal is open
            if (document.getElementById('chatModal').classList.contains('active')) {
                startChatListener();
            }
            
            // Send push notification
            sendPushNotification('Koneksi Tersambung', 'Aplikasi kembali online. Data akan disinkronkan otomatis.');
        }

        function handleOffline() {
            isOnline = false;
            document.getElementById('offlineIndicator').classList.add('show');
            updateConnectionStatus('disconnected', 'Offline - Mode lokal');
            document.getElementById('syncText').textContent = 'Offline';
            document.getElementById('syncStatus').className = 'sync-status offline';
            showToast('Anda sedang offline. Data disimpan secara lokal.', 'warning');
        }

        // ============================================
        // FUNGSI SWITCH TAB UNTUK STUDENT
        // ============================================
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabBtn = document.getElementById('tab-' + tabName) || document.getElementById('tab-student-' + tabName);
            if (tabBtn) tabBtn.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const content = document.getElementById('content-' + tabName);
            if (content) content.classList.remove('hidden');
            
            if (tabName !== 'absensi' && isScanning) {
                stopScanner();
            }

            if (tabName !== 'studentAbsen' && isStudentScanning) {
                stopStudentScanner();
            }
            
            if (tabName === 'rekap') {
                loadRekapBulanan();
            } else if (tabName === 'studentRiwayat') {
                loadStudentOwnRiwayat();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'backup') {
                loadBackupHistory();
            } else if (tabName === 'studentAbsen') {
                // Set barcode input dengan nilai siswa yang login
                document.getElementById('studentManualBarcode').value = currentStudentBarcode || '';
                // Reset status lokasi
                document.getElementById('locationStatus').className = 'location-status location-warning';
                document.getElementById('locationStatus').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mendeteksi lokasi...';
            }
        }

        // ============================================
        // KODE ASLI DARI SINI KE BAWAH TETAP SAMA (TIDAK DIUBAH)
        // ============================================

        // Fingerprint functions (sudah ada di atas, tapi untuk kelengkapan kita tulis ulang)
        // Sebenarnya fungsi-fungsi ini sudah ditambahkan di bagian atas, 
        // tetapi agar tidak terpotong, saya akan menulis ulang seluruh fungsi asli 
        // dari kode awal yang belum tercakup di bagian atas.

        // ============================================
        // FUNGSI FINGERPRINT (dari kode asli)
        // ============================================
        function isFingerprintSupported() {
            return window.PublicKeyCredential !== undefined;
        }

        function generateChallenge() {
            const array = new Uint8Array(32);
            window.crypto.getRandomValues(array);
            return array;
        }

        function strToArrayBuffer(str) {
            const encoder = new TextEncoder();
            return encoder.encode(str);
        }

        function arrayBufferToBase64(buffer) {
            const binary = String.fromCharCode(...new Uint8Array(buffer));
            return window.btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binary = window.atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function getUserId(type, identifier) {
            return `${type}_${identifier}`;
        }

        async function registerFingerprint(type, identifier, userName) {
            if (!isFingerprintSupported()) {
                showToast('Device tidak mendukung fingerprint authentication', 'error');
                return false;
            }

            try {
                const existingKeys = JSON.parse(localStorage.getItem('fingerprint_keys') || '{}');
                const userId = getUserId(type, identifier);
                
                if (existingKeys[userId]) {
                    showToast('Fingerprint sudah terdaftar untuk user ini', 'warning');
                    return false;
                }

                showFingerprintModal('register');

                const publicKeyCredentialCreationOptions = {
                    challenge: generateChallenge(),
                    rp: {
                        name: 'Absensi 12 RPL',
                        id: window.location.hostname
                    },
                    user: {
                        id: strToArrayBuffer(userId),
                        name: identifier,
                        displayName: userName
                    },
                    pubKeyCredParams: [
                        { type: 'public-key', alg: -7 },
                        { type: 'public-key', alg: -257 }
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: 'platform',
                        userVerification: 'required',
                        residentKey: 'preferred'
                    },
                    timeout: 60000,
                    attestation: 'none'
                };

                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                if (credential) {
                    existingKeys[userId] = {
                        id: arrayBufferToBase64(credential.rawId),
                        type: credential.type,
                        registeredAt: new Date().toISOString(),
                        userName: userName,
                        userType: type
                    };
                    localStorage.setItem('fingerprint_keys', JSON.stringify(existingKeys));
                    
                    updateFingerprintUI();
                    
                    showFingerprintSuccess();
                    setTimeout(() => {
                        closeFingerprintModal();
                        showToast('Fingerprint berhasil didaftarkan!', 'success');
                    }, 1000);
                    
                    return true;
                }

            } catch (error) {
                console.error('Fingerprint registration error:', error);
                showFingerprintError();
                setTimeout(() => {
                    closeFingerprintModal();
                    if (error.name === 'NotAllowedError') {
                        showToast('Pendaftaran fingerprint dibatalkan', 'warning');
                    } else {
                        showToast('Gagal mendaftarkan fingerprint: ' + error.message, 'error');
                    }
                }, 1000);
                return false;
            }
        }

        async function authenticateWithFingerprint(type, identifier) {
            if (!isFingerprintSupported()) {
                showToast('Device tidak mendukung fingerprint authentication', 'error');
                return false;
            }

            try {
                const existingKeys = JSON.parse(localStorage.getItem('fingerprint_keys') || '{}');
                const userId = getUserId(type, identifier);

                if (!existingKeys[userId]) {
                    showToast('Fingerprint belum terdaftar. Silakan login manual terlebih dahulu.', 'error');
                    return false;
                }

                showFingerprintModal('authenticate');

                const keyData = existingKeys[userId];
                
                const publicKeyCredentialRequestOptions = {
                    challenge: generateChallenge(),
                    allowCredentials: [{
                        id: base64ToArrayBuffer(keyData.id),
                        type: 'public-key',
                        transports: ['internal']
                    }],
                    userVerification: 'required',
                    timeout: 60000
                };

                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                if (assertion) {
                    showFingerprintSuccess();
                    setTimeout(() => {
                        closeFingerprintModal();
                        if (type === 'admin') {
                            const user = ADMIN_USERS.find(u => u.username === identifier);
                            if (user) {
                                currentUser = user;
                                isStudentMode = false;
                                localStorage.setItem('currentUser', JSON.stringify(user));
                                localStorage.removeItem('currentStudent');
                                showToast(`Selamat datang, ${user.name}!`, 'success');
                                showMainApp();
                            }
                        } else if (type === 'student') {
                            currentStudentBarcode = identifier;
                            isStudentMode = true;
                            localStorage.setItem('currentStudent', identifier);
                            localStorage.removeItem('currentUser');
                            const studentData = studentDatabase[identifier];
                            showToast(`Selamat datang, ${studentData ? studentData.name : 'Siswa'}!`, 'success');
                            showMainApp();
                        }
                    }, 1000);
                    return true;
                }

            } catch (error) {
                console.error('Fingerprint authentication error:', error);
                showFingerprintError();
                setTimeout(() => {
                    closeFingerprintModal();
                    if (error.name === 'NotAllowedError') {
                        showToast('Autentikasi fingerprint dibatalkan', 'warning');
                    } else {
                        showToast('Autentikasi fingerprint gagal', 'error');
                    }
                }, 1000);
                return false;
            }
        }

        async function handleFingerprintLogin(type) {
            if (type === 'admin') {
                const username = document.getElementById('loginUsername').value;
                if (!username) {
                    showToast('Masukkan username terlebih dahulu', 'error');
                    document.getElementById('loginUsername').focus();
                    return;
                }
                
                const existingKeys = JSON.parse(localStorage.getItem('fingerprint_keys') || '{}');
                const userId = getUserId('admin', username);
                
                if (existingKeys[userId]) {
                    await authenticateWithFingerprint('admin', username);
                } else {
                    const password = document.getElementById('loginPassword').value;
                    const user = ADMIN_USERS.find(u => u.username === username && u.password === password);
                    
                    if (!user) {
                        showToast('Masukkan password yang benar untuk mendaftarkan fingerprint', 'error');
                        document.getElementById('loginPassword').focus();
                        return;
                    }
                    
                    const success = await registerFingerprint('admin', username, user.name);
                    if (success) {
                        currentUser = user;
                        isStudentMode = false;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        localStorage.removeItem('currentStudent');
                        setTimeout(() => {
                            showToast(`Selamat datang, ${user.name}!`, 'success');
                            showMainApp();
                        }, 1500);
                    }
                }
                
            } else if (type === 'student') {
                const barcode = document.getElementById('studentBarcode').value.trim().toUpperCase();
                if (!barcode) {
                    showToast('Masukkan barcode terlebih dahulu', 'error');
                    document.getElementById('studentBarcode').focus();
                    return;
                }
                
                if (!studentDatabase[barcode]) {
                    showToast('Barcode tidak ditemukan', 'error');
                    return;
                }
                
                const existingKeys = JSON.parse(localStorage.getItem('fingerprint_keys') || '{}');
                const userId = getUserId('student', barcode);
                
                if (existingKeys[userId]) {
                    await authenticateWithFingerprint('student', barcode);
                } else {
                    const password = document.getElementById('studentPassword').value;
                    if (STUDENT_PASSWORDS[barcode] !== password) {
                        showToast('Masukkan password (tanggal lahir) yang benar untuk mendaftarkan fingerprint', 'error');
                        document.getElementById('studentPassword').focus();
                        return;
                    }
                    
                    const studentData = studentDatabase[barcode];
                    const success = await registerFingerprint('student', barcode, studentData.name);
                    if (success) {
                        currentStudentBarcode = barcode;
                        isStudentMode = true;
                        localStorage.setItem('currentStudent', barcode);
                        localStorage.removeItem('currentUser');
                        setTimeout(() => {
                            showToast(`Selamat datang, ${studentData.name}!`, 'success');
                            showMainApp();
                        }, 1500);
                    }
                }
            }
        }

        function showFingerprintModal(mode) {
            const modal = document.getElementById('fingerprintModal');
            const circle = document.getElementById('fingerprintCircle');
            const status = document.getElementById('fingerprintStatus');
            const hint = document.getElementById('fingerprintHint');
            
            circle.className = 'fingerprint-circle scanning';
            status.textContent = mode === 'register' ? 'Daftarkan Sidik Jari' : 'Tempelkan Sidik Jari';
            hint.textContent = 'Gunakan sensor fingerprint pada device Anda';
            
            modal.classList.add('active');
        }

        function showFingerprintSuccess() {
            const circle = document.getElementById('fingerprintCircle');
            const status = document.getElementById('fingerprintStatus');
            
            circle.className = 'fingerprint-circle success';
            circle.innerHTML = '<i class="fas fa-check"></i>';
            status.textContent = 'Berhasil!';
            status.style.color = 'var(--success)';
        }

        function showFingerprintError() {
            const circle = document.getElementById('fingerprintCircle');
            const status = document.getElementById('fingerprintStatus');
            
            circle.className = 'fingerprint-circle error';
            circle.innerHTML = '<i class="fas fa-times"></i>';
            status.textContent = 'Gagal';
            status.style.color = 'var(--danger)';
        }

        function closeFingerprintModal() {
            const modal = document.getElementById('fingerprintModal');
            const circle = document.getElementById('fingerprintCircle');
            
            modal.classList.remove('active');
            
            setTimeout(() => {
                circle.className = 'fingerprint-circle';
                circle.innerHTML = '<i class="fas fa-fingerprint"></i>';
                document.getElementById('fingerprintStatus').textContent = 'Tempelkan Sidik Jari';
                document.getElementById('fingerprintStatus').style.color = 'var(--primary-dark)';
            }, 300);
        }

        function updateFingerprintUI() {
            const existingKeys = JSON.parse(localStorage.getItem('fingerprint_keys') || '{}');
            
            const adminUsername = document.getElementById('loginUsername').value;
            if (adminUsername) {
                const adminUserId = getUserId('admin', adminUsername);
                const adminBtn = document.getElementById('adminFingerprintBtn');
                const adminText = document.getElementById('adminFingerprintText');
                const adminList = document.getElementById('adminFingerprintList');
                
                if (existingKeys[adminUserId]) {
                    adminBtn.classList.add('fingerprint-registered');
                    adminText.textContent = 'Login dengan Fingerprint';
                    adminList.style.display = 'block';
                    adminList.innerHTML = `
                        <div class="fingerprint-item">
                            <div class="fingerprint-item-info">
                                <div class="fingerprint-item-icon">
                                    <i class="fas fa-fingerprint"></i>
                                </div>
                                <div>
                                    <div class="fingerprint-item-name">${existingKeys[adminUserId].userName}</div>
                                    <div class="fingerprint-item-date">Terdaftar: ${new Date(existingKeys[adminUserId].registeredAt).toLocaleDateString('id-ID')}</div>
                                </div>
                            </div>
                            <button class="fingerprint-delete" onclick="deleteFingerprint('${adminUserId}')" title="Hapus fingerprint">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                } else {
                    adminBtn.classList.remove('fingerprint-registered');
                    adminText.textContent = 'Daftarkan Fingerprint';
                    adminList.style.display = 'none';
                }
            }
            
            const studentBarcode = document.getElementById('studentBarcode').value.trim().toUpperCase();
            if (studentBarcode) {
                const studentUserId = getUserId('student', studentBarcode);
                const studentBtn = document.getElementById('studentFingerprintBtn');
                const studentText = document.getElementById('studentFingerprintText');
                const studentList = document.getElementById('studentFingerprintList');
                
                if (existingKeys[studentUserId]) {
                    studentBtn.classList.add('fingerprint-registered');
                    studentText.textContent = 'Login dengan Fingerprint';
                    studentList.style.display = 'block';
                    studentList.innerHTML = `
                        <div class="fingerprint-item">
                            <div class="fingerprint-item-info">
                                <div class="fingerprint-item-icon">
                                    <i class="fas fa-fingerprint"></i>
                                </div>
                                <div>
                                    <div class="fingerprint-item-name">${existingKeys[studentUserId].userName}</div>
                                    <div class="fingerprint-item-date">Terdaftar: ${new Date(existingKeys[studentUserId].registeredAt).toLocaleDateString('id-ID')}</div>
                                </div>
                            </div>
                            <button class="fingerprint-delete" onclick="deleteFingerprint('${studentUserId}')" title="Hapus fingerprint">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                } else {
                    studentBtn.classList.remove('fingerprint-registered');
                    studentText.textContent = 'Daftarkan Fingerprint';
                    studentList.style.display = 'none';
                }
            }
        }

        function deleteFingerprint(userId) {
            if (confirm('Apakah Anda yakin ingin menghapus data fingerprint ini?')) {
                const existingKeys = JSON.parse(localStorage.getItem('fingerprint_keys') || '{}');
                delete existingKeys[userId];
                localStorage.setItem('fingerprint_keys', JSON.stringify(existingKeys));
                updateFingerprintUI();
                showToast('Fingerprint berhasil dihapus', 'success');
            }
        }

        document.getElementById('loginUsername')?.addEventListener('input', updateFingerprintUI);
        document.getElementById('studentBarcode')?.addEventListener('input', updateFingerprintUI);

        // ============================================
        // PWA & SERVICE WORKER FUNCTIONS
        // ============================================
        function initPWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                    const CACHE_NAME = 'absensi-cache-v1';
                    const urlsToCache = [
                        '/',
                        '/index.html'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                        self.skipWaiting();
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request)
                                        .then(response => {
                                            if(!response || response.status !== 200 || response.type !== 'basic') {
                                                return response;
                                            }
                                            const responseToCache = response.clone();
                                            caches.open(CACHE_NAME)
                                                .then(cache => {
                                                    cache.put(event.request, responseToCache);
                                                });
                                            return response;
                                        });
                                })
                                .catch(() => {
                                    if (event.request.mode === 'navigate') {
                                        return caches.match('/index.html');
                                    }
                                })
                        );
                    });

                    self.addEventListener('sync', event => {
                        if (event.tag === 'sync-attendance') {
                            event.waitUntil(syncAttendanceData());
                        }
                    });

                    self.addEventListener('push', event => {
                        const data = event.data.json();
                        const options = {
                            body: data.body,
                            icon: 'https://cdn-icons-png.flaticon.com/512/2922/2922506.png',
                            badge: 'https://cdn-icons-png.flaticon.com/512/2922/2922506.png',
                            vibrate: [100, 50, 100],
                            data: data.data || {},
                            actions: data.actions || []
                        };
                        event.waitUntil(
                            self.registration.showNotification(data.title, options)
                        );
                    });

                    async function syncAttendanceData() {
                        console.log('Background sync triggered');
                    }
                `)).then(registration => {
                    console.log('ServiceWorker registered:', registration);
                }).catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
            }

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installPwaBtn').classList.add('show');
            });

            if (window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('installPwaBtn').style.display = 'none';
            }
        }

        function installPWA() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    showToast('Aplikasi berhasil diinstall!', 'success');
                    document.getElementById('installPwaBtn').classList.remove('show');
                }
                deferredPrompt = null;
            });
        }

        // ============================================
        // PUSH NOTIFICATION FUNCTIONS
        // ============================================
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                document.getElementById('notificationBtn').style.display = 'none';
                return;
            }

            const btn = document.getElementById('notificationBtn');
            if (Notification.permission === 'granted') {
                btn.classList.add('granted');
                btn.innerHTML = '<i class="fas fa-bell"></i>';
                btn.title = 'Notifikasi Aktif';
            } else if (Notification.permission === 'denied') {
                btn.classList.add('denied');
                btn.innerHTML = '<i class="fas fa-bell-slash"></i>';
                btn.title = 'Notifikasi Ditolak';
            }
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('Browser tidak mendukung notifikasi', 'error');
                return;
            }

            Notification.requestPermission().then(permission => {
                const btn = document.getElementById('notificationBtn');
                if (permission === 'granted') {
                    btn.classList.remove('denied');
                    btn.classList.add('granted');
                    btn.innerHTML = '<i class="fas fa-bell"></i>';
                    btn.title = 'Notifikasi Aktif';
                    showToast('Notifikasi berhasil diaktifkan!', 'success');
                    
                    subscribeToPushNotifications();
                } else {
                    btn.classList.add('denied');
                    btn.innerHTML = '<i class="fas fa-bell-slash"></i>';
                    btn.title = 'Notifikasi Ditolak';
                    showToast('Izin notifikasi ditolak', 'error');
                }
            });
        }

        function subscribeToPushNotifications() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    console.log('Push notification subscription ready');
                });
            }
        }

        function sendPushNotification(title, body, data = {}) {
            if (Notification.permission === 'granted') {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification(title, {
                        body: body,
                        icon: 'https://cdn-icons-png.flaticon.com/512/2922/2922506.png',
                        badge: 'https://cdn-icons-png.flaticon.com/512/2922/2922506.png',
                        vibrate: [100, 50, 100],
                        data: data,
                        requireInteraction: true,
                        actions: [
                            { action: 'open', title: 'Buka Aplikasi' },
                            { action: 'close', title: 'Tutup' }
                        ]
                    });
                });
            }
        }

        // ============================================
        // DATE CHANGE & AUTO SAVE HISTORY
        // ============================================
        function checkDateChange() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            const lastDate = localStorage.getItem('lastProcessedDate');
            
            if (lastDate && lastDate !== todayStr) {
                saveCurrentDataToHistory(lastDate);
            }
            
            if (now.getDate() !== currentDate.getDate() || 
                now.getMonth() !== currentDate.getMonth() || 
                now.getFullYear() !== currentDate.getFullYear()) {
                currentDate = now;
                updateDateDisplay();
                loadTodayData();
                showToast('Hari baru! Data absensi direset untuk tanggal baru.', 'warning');
                
                sendPushNotification('Hari Baru', 'Data absensi telah direset untuk hari ini. Jangan lupa cek kehadiran siswa!');
            }
            
            localStorage.setItem('lastProcessedDate', todayStr);
        }

        function saveCurrentDataToHistory(dateStr) {
            if (!db) return;
            
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(dateStr);
            
            request.onsuccess = () => {
                const dayData = request.result || [];
                
                if (dayData.length === 0) return;
                
                const historyTransaction = db.transaction(['attendanceHistory'], 'readwrite');
                const historyStore = historyTransaction.objectStore('attendanceHistory');
                
                dayData.forEach(record => {
                    const historyRecord = {
                        ...record,
                        historyDate: dateStr,
                        savedAt: new Date().toISOString()
                    };
                    historyStore.add(historyRecord);
                });
                
                const studentHistoryTransaction = db.transaction(['studentHistory'], 'readwrite');
                const studentHistoryStore = studentHistoryTransaction.objectStore('studentHistory');
                
                dayData.forEach(record => {
                    const studentHistoryRecord = {
                        barcode: record.barcode,
                        name: record.name,
                        class: record.class,
                        major: record.major,
                        date: record.date,
                        time: record.time,
                        status: record.status,
                        bolosTime: record.bolosTime,
                        operator: record.operator,
                        timestamp: record.timestamp
                    };
                    studentHistoryStore.add(studentHistoryRecord);
                });
                
                const clearTransaction = db.transaction(['attendance'], 'readwrite');
                const clearStore = clearTransaction.objectStore('attendance');
                const clearIndex = clearStore.index('date');
                const clearRequest = clearIndex.openCursor(IDBKeyRange.only(dateStr));
                
                clearRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        clearStore.delete(cursor.primaryKey);
                        cursor.continue();
                    }
                };
                
                if (firebaseDB && isOnline) {
                    syncHistoryToFirebase(dateStr, dayData);
                }
                
                sendPushNotification('Riwayat Tersimpan', `Data absensi tanggal ${dateStr} telah tersimpan ke riwayat.`);
                
                console.log(`Saved ${dayData.length} records to history for ${dateStr}`);
            };
        }

        function syncHistoryToFirebase(dateStr, data) {
            if (!firebaseDB) return;
            
            const historyRef = firebaseDB.ref(`history/${dateStr}`);
            const historyData = {};
            
            data.forEach((item, index) => {
                const key = item.barcode + '_' + (item.timestamp || index);
                historyData[key] = {
                    ...item,
                    historyDate: dateStr,
                    savedAt: new Date().toISOString()
                };
            });
            
            historyRef.set(historyData);
        }

        // ============================================
        // ANALYTICS DASHBOARD FUNCTIONS
        // ============================================
        function loadAnalytics() {
            if (!db || isStudentMode) return;
            
            const range = parseInt(document.getElementById('analyticsRange').value);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - range);
            
            const transaction = db.transaction(['attendance', 'attendanceHistory'], 'readonly');
            const store = transaction.objectStore('attendance');
            const historyStore = transaction.objectStore('attendanceHistory');
            
            const request = store.getAll();
            const historyRequest = historyStore.getAll();
            
            Promise.all([
                new Promise((resolve) => { request.onsuccess = () => resolve(request.result || []); }),
                new Promise((resolve) => { historyRequest.onsuccess = () => resolve(historyRequest.result || []); })
            ]).then(([currentData, historyData]) => {
                const allData = [...currentData, ...historyData];
                
                const filteredData = allData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= startDate && itemDate <= endDate;
                });
                
                renderAnalyticsSummary(filteredData, range);
                renderAttendanceTrend(filteredData, startDate, endDate, range);
                renderStatusDistribution(filteredData);
                renderHeatmap(filteredData);
                renderRiskPrediction(filteredData);
            });
        }

        function renderAnalyticsSummary(data, range) {
            const totalRecords = data.length;
            const uniqueStudents = new Set(data.map(item => item.barcode)).size;
            const hadirCount = data.filter(item => item.status === 'hadir').length;
            const avgAttendance = totalRecords > 0 ? ((hadirCount / totalRecords) * 100).toFixed(1) : 0;
            
            const summaryDiv = document.getElementById('analyticsSummary');
            summaryDiv.innerHTML = `
                <div class="analytics-summary-item">
                    <div class="analytics-summary-value">${totalRecords}</div>
                    <div class="analytics-summary-label">Total Records</div>
                </div>
                <div class="analytics-summary-item">
                    <div class="analytics-summary-value">${uniqueStudents}</div>
                    <div class="analytics-summary-label">Siswa Aktif</div>
                </div>
                <div class="analytics-summary-item">
                    <div class="analytics-summary-value">${avgAttendance}%</div>
                    <div class="analytics-summary-label">Rata-rata Hadir</div>
                </div>
                <div class="analytics-summary-item">
                    <div class="analytics-summary-value">${range}</div>
                    <div class="analytics-summary-label">Hari Terakhir</div>
                </div>
            `;
        }

        function renderAttendanceTrend(data, startDate, endDate, range) {
            const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
            
            const dateMap = {};
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                dateMap[dateStr] = { hadir: 0, bolos: 0, izin: 0, sakit: 0, total: 0 };
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            data.forEach(item => {
                if (dateMap[item.date]) {
                    dateMap[item.date][item.status]++;
                    dateMap[item.date].total++;
                }
            });
            
            const labels = Object.keys(dateMap).sort();
            const hadirData = labels.map(date => dateMap[date].hadir);
            const bolosData = labels.map(date => dateMap[date].bolos);
            const izinData = labels.map(date => dateMap[date].izin);
            const sakitData = labels.map(date => dateMap[date].sakit);
            
            const formattedLabels = labels.map(date => {
                const d = new Date(date);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });
            
            if (attendanceTrendChart) {
                attendanceTrendChart.destroy();
            }
            
            attendanceTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [
                        {
                            label: 'Hadir',
                            data: hadirData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Bolos',
                            data: bolosData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Izin',
                            data: izinData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Sakit',
                            data: sakitData,
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: true
                        }
                    }
                }
            });
        }

        function renderStatusDistribution(data) {
            const ctx = document.getElementById('statusDistributionChart').getContext('2d');
            
            const hadir = data.filter(item => item.status === 'hadir').length;
            const bolos = data.filter(item => item.status === 'bolos').length;
            const izin = data.filter(item => item.status === 'izin').length;
            const sakit = data.filter(item => item.status === 'sakit').length;
            
            if (statusDistributionChart) {
                statusDistributionChart.destroy();
            }
            
            statusDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Hadir', 'Bolos', 'Izin', 'Sakit'],
                    datasets: [{
                        data: [hadir, bolos, izin, sakit],
                        backgroundColor: ['#10b981', '#ef4444', '#8b5cf6', '#f97316'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderHeatmap(data) {
            const container = document.getElementById('attendanceHeatmap');
            
            const studentStats = {};
            Object.keys(studentDatabase).forEach(barcode => {
                studentStats[barcode] = { hadir: 0, total: 0, name: studentDatabase[barcode].name };
            });
            
            data.forEach(item => {
                if (studentStats[item.barcode]) {
                    studentStats[item.barcode].total++;
                    if (item.status === 'hadir') {
                        studentStats[item.barcode].hadir++;
                    }
                }
            });
            
            const sortedStudents = Object.entries(studentStats)
                .filter(([_, stats]) => stats.total > 0)
                .sort((a, b) => {
                    const rateA = a[1].hadir / a[1].total;
                    const rateB = b[1].hadir / b[1].total;
                    return rateA - rateB;
                })
                .slice(0, 50);
            
            container.innerHTML = sortedStudents.map(([barcode, stats]) => {
                const rate = stats.total > 0 ? (stats.hadir / stats.total) : 0;
                let color, textColor;
                
                if (rate >= 1) {
                    color = '#10b981';
                    textColor = 'white';
                } else if (rate >= 0.75) {
                    color = '#d1fae5';
                    textColor = '#065f46';
                } else if (rate >= 0.5) {
                    color = '#fef3c7';
                    textColor = '#92400e';
                } else {
                    color = '#fee2e2';
                    textColor = '#991b1b';
                }
                
                return `
                    <div class="heatmap-cell" style="background: ${color}; color: ${textColor};" 
                         title="${stats.name}: ${(rate * 100).toFixed(0)}% (${stats.hadir}/${stats.total})">
                        ${(rate * 100).toFixed(0)}%
                    </div>
                `;
            }).join('');
        }

        function renderRiskPrediction(data) {
            const container = document.getElementById('riskPredictionList');
            
            const studentStats = {};
            Object.keys(studentDatabase).forEach(barcode => {
                studentStats[barcode] = { 
                    hadir: 0, 
                    bolos: 0, 
                    izin: 0, 
                    sakit: 0,
                    total: 0, 
                    name: studentDatabase[barcode].name,
                    class: studentDatabase[barcode].class
                };
            });
            
            data.forEach(item => {
                if (studentStats[item.barcode]) {
                    studentStats[item.barcode].total++;
                    studentStats[item.barcode][item.status]++;
                }
            });
            
            const riskStudents = Object.entries(studentStats)
                .filter(([_, stats]) => stats.total >= 3)
                .map(([barcode, stats]) => {
                    const attendanceRate = stats.hadir / stats.total;
                    const bolosRate = stats.bolos / stats.total;
                    let riskLevel, riskClass;
                    
                    if (attendanceRate < 0.5 || bolosRate > 0.5) {
                        riskLevel = 'High';
                        riskClass = 'risk-high';
                    } else if (attendanceRate < 0.75 || bolosRate > 0.25) {
                        riskLevel = 'Medium';
                        riskClass = 'risk-medium';
                    } else {
                        riskLevel = 'Low';
                        riskClass = 'risk-low';
                    }
                    
                    return {
                        barcode,
                        ...stats,
                        attendanceRate,
                        riskLevel,
                        riskClass
                    };
                })
                .filter(student => student.riskLevel !== 'Low')
                .sort((a, b) => a.attendanceRate - b.attendanceRate);
            
            if (riskStudents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 2rem;">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        <p>Tidak ada siswa berisiko tinggi saat ini</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = riskStudents.map(student => `
                <div class="prediction-item">
                    <div class="prediction-info">
                        <span class="prediction-name">${student.name}</span>
                        <span class="prediction-detail">
                            Kehadiran: ${(student.attendanceRate * 100).toFixed(1)}% | 
                            Bolos: ${student.bolos} | 
                            Total: ${student.total} hari
                        </span>
                    </div>
                    <span class="risk-indicator ${student.riskClass}">
                        <i class="fas fa-exclamation-circle"></i>
                        ${student.riskLevel}
                    </span>
                </div>
            `).join('');
        }

        // ============================================
        // BACKUP & RESTORE FUNCTIONS
        // ============================================
        function exportDatabase() {
            if (!db) return;
            
            const password = document.getElementById('backupPassword').value;
            const progressBar = document.getElementById('exportProgress');
            const progressFill = document.getElementById('exportProgressFill');
            
            progressBar.classList.add('active');
            progressFill.style.width = '0%';
            
            const transaction = db.transaction(['attendance', 'attendanceHistory', 'studentHistory'], 'readonly');
            
            Promise.all([
                new Promise((resolve) => {
                    const store = transaction.objectStore('attendance');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                }),
                new Promise((resolve) => {
                    const store = transaction.objectStore('attendanceHistory');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                }),
                new Promise((resolve) => {
                    const store = transaction.objectStore('studentHistory');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                })
            ]).then(([attendance, history, studentHistory]) => {
                progressFill.style.width = '50%';
                
                const backupData = {
                    version: DB_VERSION,
                    exportedAt: new Date().toISOString(),
                    exportedBy: currentUser ? currentUser.name : 'Unknown',
                    attendance: attendance,
                    attendanceHistory: history,
                    studentHistory: studentHistory
                };
                
                let dataStr = JSON.stringify(backupData, null, 2);
                let filename = `absensi_backup_${new Date().toISOString().split('T')[0]}.json`;
                
                if (password) {
                    dataStr = encryptData(dataStr, password);
                    filename += '.enc';
                }
                
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                progressFill.style.width = '100%';
                
                saveBackupHistory(filename, blob.size, password ? 'Encrypted' : 'Plain');
                
                setTimeout(() => {
                    progressBar.classList.remove('active');
                    showToast(`Backup berhasil: ${filename}`, 'success');
                    document.getElementById('backupPassword').value = '';
                }, 500);
            });
        }

        function importDatabase() {
            const fileInput = document.getElementById('backupFileInput');
            const password = document.getElementById('restorePassword').value;
            const progressBar = document.getElementById('importProgress');
            const progressFill = document.getElementById('importProgressFill');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Pilih file backup terlebih dahulu!', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            progressBar.classList.add('active');
            progressFill.style.width = '0%';
            
            reader.onload = (e) => {
                try {
                    progressFill.style.width = '30%';
                    
                    let dataStr = e.target.result;
                    
                    if (file.name.endsWith('.enc') || password) {
                        if (!password) {
                            showToast('File terenkripsi. Masukkan password!', 'error');
                            progressBar.classList.remove('active');
                            return;
                        }
                        dataStr = decryptData(dataStr, password);
                    }
                    
                    const backupData = JSON.parse(dataStr);
                    progressFill.style.width = '50%';
                    
                    if (!backupData.attendance || !Array.isArray(backupData.attendance)) {
                        throw new Error('Format file tidak valid');
                    }
                    
                    if (!confirm(`Restore data dari ${backupData.exportedAt}?\nIni akan menambahkan data ke database existing.`)) {
                        progressBar.classList.remove('active');
                        return;
                    }
                    
                    const transaction = db.transaction(['attendance', 'attendanceHistory', 'studentHistory'], 'readwrite');
                    
                    const attendanceStore = transaction.objectStore('attendance');
                    const historyStore = transaction.objectStore('attendanceHistory');
                    const studentHistoryStore = transaction.objectStore('studentHistory');
                    
                    let restoredCount = 0;
                    
                    backupData.attendance.forEach(item => {
                        attendanceStore.put(item);
                        restoredCount++;
                    });
                    
                    if (backupData.attendanceHistory) {
                        backupData.attendanceHistory.forEach(item => {
                            historyStore.put(item);
                            restoredCount++;
                        });
                    }
                    
                    if (backupData.studentHistory) {
                        backupData.studentHistory.forEach(item => {
                            studentHistoryStore.put(item);
                            restoredCount++;
                        });
                    }
                    
                    transaction.oncomplete = () => {
                        progressFill.style.width = '100%';
                        setTimeout(() => {
                            progressBar.classList.remove('active');
                            showToast(`Restore berhasil! ${restoredCount} records dipulihkan.`, 'success');
                            fileInput.value = '';
                            document.getElementById('backupFileLabel').innerHTML = `
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem; display: block;"></i>
                                <span>Klik untuk pilih file backup</span>
                            `;
                            document.getElementById('restorePassword').value = '';
                            
                            loadTodayData();
                            loadBackupHistory();
                        }, 500);
                    };
                    
                } catch (error) {
                    progressBar.classList.remove('active');
                    showToast('Error restore: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function handleBackupFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('backupFileText').textContent = file.name;
            }
        }

        function encryptData(text, password) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ password.charCodeAt(i % password.length);
                result += String.fromCharCode(charCode);
            }
            return btoa(result);
        }

        function decryptData(encryptedText, password) {
            try {
                const text = atob(encryptedText);
                let result = '';
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i) ^ password.charCodeAt(i % password.length);
                    result += String.fromCharCode(charCode);
                }
                return result;
            } catch (e) {
                throw new Error('Password salah atau file rusak');
            }
        }

        function backupToLocalStorage() {
            if (!db) return;
            
            const transaction = db.transaction(['attendance', 'attendanceHistory'], 'readonly');
            
            Promise.all([
                new Promise((resolve) => {
                    const store = transaction.objectStore('attendance');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                }),
                new Promise((resolve) => {
                    const store = transaction.objectStore('attendanceHistory');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                })
            ]).then(([attendance, history]) => {
                const backupData = {
                    timestamp: new Date().toISOString(),
                    attendance: attendance,
                    history: history
                };
                
                localStorage.setItem('absensi_auto_backup', JSON.stringify(backupData));
                localStorage.setItem('absensi_last_backup', new Date().toISOString());
                
                document.getElementById('lastBackupDate').textContent = new Date().toLocaleString('id-ID');
                showToast('Backup ke local storage berhasil!', 'success');
            });
        }

        function toggleAutoBackup() {
            const enabled = document.getElementById('autoBackupEnabled').checked;
            localStorage.setItem('absensi_auto_backup_enabled', enabled);
            
            if (enabled) {
                backupToLocalStorage();
                setInterval(() => {
                    if (document.getElementById('autoBackupEnabled').checked) {
                        backupToLocalStorage();
                    }
                }, 24 * 60 * 60 * 1000);
                showToast('Auto backup diaktifkan', 'success');
            } else {
                showToast('Auto backup dimatikan', 'warning');
            }
        }

        function saveBackupHistory(filename, size, type) {
            let history = JSON.parse(localStorage.getItem('absensi_backup_history') || '[]');
            history.unshift({
                date: new Date().toISOString(),
                filename: filename,
                size: formatFileSize(size),
                type: type
            });
            history = history.slice(0, 10);
            localStorage.setItem('absensi_backup_history', JSON.stringify(history));
            loadBackupHistory();
        }

        function loadBackupHistory() {
            const history = JSON.parse(localStorage.getItem('absensi_backup_history') || '[]');
            const tbody = document.getElementById('backupHistoryBody');
            
            if (history.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="4">
                            <i class="fas fa-inbox"></i>
                            <p>Belum ada riwayat backup</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = history.map((item, index) => `
                <tr>
                    <td>${new Date(item.date).toLocaleString('id-ID')}</td>
                    <td>${item.size}</td>
                    <td><span class="badge ${item.type === 'Encrypted' ? 'badge-purple' : 'badge-success'}">${item.type}</span></td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="deleteBackupHistory(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            const lastBackup = localStorage.getItem('absensi_last_backup');
            if (lastBackup) {
                document.getElementById('lastBackupDate').textContent = new Date(lastBackup).toLocaleString('id-ID');
            }
            
            const autoBackup = localStorage.getItem('absensi_auto_backup_enabled') === 'true';
            document.getElementById('autoBackupEnabled').checked = autoBackup;
        }

        function deleteBackupHistory(index) {
            let history = JSON.parse(localStorage.getItem('absensi_backup_history') || '[]');
            history.splice(index, 1);
            localStorage.setItem('absensi_backup_history', JSON.stringify(history));
            loadBackupHistory();
        }

        function clearBackupHistory() {
            if (confirm('Hapus semua riwayat backup?')) {
                localStorage.removeItem('absensi_backup_history');
                loadBackupHistory();
                showToast('Riwayat backup dihapus', 'success');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ============================================
        // FIREBASE INITIALIZATION & SYNC
        // ============================================
        function initFirebase() {
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("Dummy")) {
                    console.warn("Firebase belum dikonfigurasi dengan benar. Sinkronisasi multi-device tidak aktif.");
                    updateConnectionStatus('disconnected', 'Firebase belum dikonfigurasi');
                    return;
                }

                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseDB = firebase.database();
                
                console.log("Firebase initialized successfully");
                
                const connectedRef = firebase.database().ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    if (snap.val() === true) {
                        isOnline = true;
                        updateConnectionStatus('connected', 'Terhubung ke server');
                        document.getElementById('syncText').textContent = 'Online';
                        document.getElementById('syncStatus').className = 'sync-status online';
                        
                        startFirebaseListener();
                        
                        if (!isStudentMode && currentUser) {
                            startChatListener();
                        }
                        
                        syncLocalToFirebase();
                    } else {
                        isOnline = false;
                        updateConnectionStatus('disconnected', 'Offline - Mode lokal');
                        document.getElementById('syncText').textContent = 'Offline';
                        document.getElementById('syncStatus').className = 'sync-status offline';
                    }
                });

            } catch (error) {
                console.error("Firebase init error:", error);
                updateConnectionStatus('disconnected', 'Gagal terhubung: ' + error.message);
                showToast('Gagal terhubung ke Firebase: ' + error.message, 'error');
            }
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;
            statusEl.innerHTML = `
                <i class="fas fa-circle"></i>
                <span>${message}</span>
            `;
            statusEl.classList.remove('hidden');
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        function startFirebaseListener() {
            if (!firebaseDB || isStudentMode) return;
            
            const today = getTodayString();
            const attendanceRef = firebaseDB.ref(`attendance/${today}`);
            
            if (syncListener) {
                syncListener.off();
            }
            
            syncListener = attendanceRef;
            
            attendanceRef.on('value', (snapshot) => {
                const firebaseData = snapshot.val();
                if (firebaseData) {
                    const dataArray = Object.values(firebaseData);
                    updateLocalDBFromFirebase(dataArray);
                }
            }, (error) => {
                console.error("Firebase listener error:", error);
            });
            
            firebaseDB.ref('.info/serverTimeOffset').on('value', (snapshot) => {
                const serverTime = Date.now() + snapshot.val();
                const serverDate = new Date(serverTime);
                if (serverDate.toISOString().split('T')[0] !== today) {
                    currentDate = serverDate;
                    updateDateDisplay();
                    loadTodayData();
                }
            });
        }

        function updateLocalDBFromFirebase(firebaseData) {
            if (!db) return;
            
            const transaction = db.transaction(['attendance'], 'readwrite');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            
            const request = index.openCursor(IDBKeyRange.only(getTodayString()));
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    store.delete(cursor.primaryKey);
                    cursor.continue();
                } else {
                    firebaseData.forEach(item => {
                        delete item.firebaseKey;
                        store.add(item);
                    });
                    
                    loadTodayData();
                }
            };
        }

        function syncLocalToFirebase() {
            if (!firebaseDB || !db || isStudentMode) return;
            
            const today = getTodayString();
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(today);
            
            request.onsuccess = () => {
                const localData = request.result || [];
                const attendanceRef = firebaseDB.ref(`attendance/${today}`);
                
                const firebaseData = {};
                localData.forEach((item, index) => {
                    const key = item.barcode + '_' + (item.timestamp || index);
                    firebaseData[key] = item;
                });
                
                if (localData.length > 0) {
                    attendanceRef.update(firebaseData);
                }
            };
        }

        function broadcastToFirebase(action, data) {
            if (!firebaseDB || !isOnline) {
                broadcastToLocalStorage(action, data);
                return;
            }
            
            const today = getTodayString();
            const attendanceRef = firebaseDB.ref(`attendance/${today}`);
            
            switch(action) {
                case 'ADD':
                    const key = data.barcode + '_' + (data.timestamp || Date.now());
                    attendanceRef.child(key).set(data);
                    break;
                    
                case 'DELETE':
                    attendanceRef.once('value', (snapshot) => {
                        const firebaseData = snapshot.val();
                        if (firebaseData) {
                            Object.keys(firebaseData).forEach(key => {
                                if (firebaseData[key].id === data.id || 
                                    (firebaseData[key].barcode === data.barcode && 
                                     firebaseData[key].timestamp === data.timestamp)) {
                                    attendanceRef.child(key).remove();
                                }
                            });
                        }
                    });
                    break;
                    
                case 'UPDATE':
                    attendanceRef.once('value', (snapshot) => {
                        const firebaseData = snapshot.val();
                        if (firebaseData) {
                            Object.keys(firebaseData).forEach(key => {
                                if (firebaseData[key].id === data.id || 
                                    (firebaseData[key].barcode === data.barcode && 
                                     firebaseData[key].timestamp === data.timestamp)) {
                                    attendanceRef.child(key).update(data);
                                }
                            });
                        }
                    });
                    break;
            }
        }

        function broadcastToLocalStorage(action, data) {
            const message = {
                action: action,
                data: data,
                timestamp: Date.now(),
                source: 'absensi_app'
            };
            localStorage.setItem('absensi_sync', JSON.stringify(message));
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'absensi_sync',
                newValue: JSON.stringify(message)
            }));
        }

        window.addEventListener('storage', (e) => {
            if (e.key === 'absensi_sync') {
                try {
                    const message = JSON.parse(e.newValue);
                    if (message.source === 'absensi_app' && message.timestamp > Date.now() - 5000) {
                        handleSyncMessage(message);
                    }
                } catch (err) {
                    console.error("Sync error:", err);
                }
            }
        });

        function handleSyncMessage(message) {
            if (isStudentMode) return;
            
            switch(message.action) {
                case 'ADD':
                    showToast(`Data baru ditambahkan oleh admin lain`, 'info');
                    loadTodayData();
                    break;
                case 'DELETE':
                    showToast('Data dihapus oleh admin lain', 'info');
                    loadTodayData();
                    break;
                case 'UPDATE':
                    showToast('Data diperbarui oleh admin lain', 'info');
                    loadTodayData();
                    break;
            }
        }

        // ============================================
        // LOGIN & AUTHENTICATION
        // ============================================
        function switchLoginTab(tab) {
            const adminForm = document.getElementById('adminLoginForm');
            const studentForm = document.getElementById('studentLoginForm');
            const adminTab = document.getElementById('tab-login-admin');
            const studentTab = document.getElementById('tab-login-siswa');
            
            if (tab === 'admin') {
                adminForm.classList.remove('hidden');
                studentForm.classList.add('hidden');
                adminTab.classList.add('active');
                studentTab.classList.remove('active');
            } else {
                adminForm.classList.add('hidden');
                studentForm.classList.remove('hidden');
                adminTab.classList.remove('active');
                studentTab.classList.add('active');
            }
            
            setTimeout(updateFingerprintUI, 100);
        }

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            const savedStudent = localStorage.getItem('currentStudent');
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isStudentMode = false;
                showMainApp();
            } else if (savedStudent) {
                currentStudentBarcode = savedStudent;
                isStudentMode = true;
                showMainApp();
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            if (isStudentMode) {
                document.getElementById('adminNavTabs').classList.add('hidden');
                document.getElementById('studentNavTabs').classList.remove('hidden');
                
                const studentData = studentDatabase[currentStudentBarcode];
                document.getElementById('userInfo').innerHTML = `
                    <i class="fas fa-user-graduate"></i>
                    <span>${studentData ? studentData.name : 'Siswa'}</span>
                `;
                
                setTimeout(() => {
                    loadStudentOwnRiwayat();
                }, 100);
            } else {
                document.getElementById('adminNavTabs').classList.remove('hidden');
                document.getElementById('studentNavTabs').classList.add('hidden');
                
                if (currentUser) {
                    document.getElementById('userInfo').innerHTML = `
                        <i class="fas fa-user-circle"></i>
                        <span>${currentUser.name}</span>
                    `;
                }
                
                loadTodayData();
                
                if (firebaseDB) {
                    startFirebaseListener();
                    startChatListener();
                }
            }
        }

        // ============================================
        // CORE FUNCTIONS (IndexedDB)
        // ============================================
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => showToast('Error membuka database', 'error');
            
            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('Database opened successfully');
            };
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                
                if (!db.objectStoreNames.contains('attendance')) {
                    const store = db.createObjectStore('attendance', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('date', 'date', { unique: false });
                    store.createIndex('barcode', 'barcode', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('attendanceHistory')) {
                    const historyStore = db.createObjectStore('attendanceHistory', { keyPath: 'id', autoIncrement: true });
                    historyStore.createIndex('historyDate', 'historyDate', { unique: false });
                    historyStore.createIndex('barcode', 'barcode', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('studentHistory')) {
                    const studentHistoryStore = db.createObjectStore('studentHistory', { keyPath: 'id', autoIncrement: true });
                    studentHistoryStore.createIndex('barcode', 'barcode', { unique: false });
                    studentHistoryStore.createIndex('date', 'date', { unique: false });
                }
            };
        }

        function updateDateDisplay() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = currentDate.toLocaleDateString('id-ID', options);
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentDay').textContent = currentDate.toLocaleDateString('id-ID', { weekday: 'long' });
        }

        function getTodayString() {
            return currentDate.toISOString().split('T')[0];
        }

        // ============================================
        // ABSENSI FUNCTIONS
        // ============================================
        function toggleScanner() {
            if (isScanning) {
                stopScanner();
            } else {
                startScanner();
            }
        }

        function startScanner() {
            const container = document.getElementById('scannerContainer');
            const status = document.getElementById('scannerStatus');
            const btn = document.getElementById('toggleBtn');
            
            container.style.display = 'block';
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memulai kamera...';
            status.classList.add('scanning');
            
            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScanning = true;
                btn.innerHTML = '<i class="fas fa-stop"></i> Berhenti';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');
                status.innerHTML = '<i class="fas fa-camera"></i> Scanner aktif - Arahkan barcode ke kamera';
            }).catch(err => {
                status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error: ' + err;
                status.classList.remove('scanning');
                container.style.display = 'none';
                showToast('Gagal mengakses kamera: ' + err, 'error');
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    document.getElementById('scannerContainer').style.display = 'none';
                    document.getElementById('scannerStatus').innerHTML = '<i class="fas fa-info-circle"></i> Scanner dihentikan';
                    document.getElementById('scannerStatus').classList.remove('scanning');
                    document.getElementById('toggleBtn').innerHTML = '<i class="fas fa-power-off"></i> Mulai';
                    document.getElementById('toggleBtn').classList.remove('btn-danger');
                    document.getElementById('toggleBtn').classList.add('btn-primary');
                });
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (decodedText) {
                processBarcode(decodedText);
            }
        }

        function onScanFailure(error) {
            // ignore
        }

        function processBarcode(barcode) {
            if (!barcode || !db) return;
            
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(getTodayString());
            
            request.onsuccess = () => {
                const todayData = request.result || [];
                const existing = todayData.find(item => item.barcode === barcode);
                
                if (existing) {
                    showToast(`Siswa dengan barcode ${barcode} sudah absen hari ini!`, 'warning');
                    return;
                }
                
                const student = studentDatabase[barcode];
                
                if (student) {
                    addAttendance(barcode, student.name, student.class, student.major, 'hadir');
                    showToast(`Berhasil! ${student.name} telah absen`, 'success');
                    playBeep();
                    
                    sendPushNotification('Absensi Berhasil', `${student.name} telah melakukan absensi.`);
                } else {
                    document.getElementById('modalBarcode').value = barcode;
                    openModal();
                    showToast('Barcode tidak dikenali. Silakan tambahkan data siswa.', 'warning');
                }
            };
        }

        function processManualInput() {
            const barcode = document.getElementById('manualBarcode').value.trim();
            
            if (!barcode) {
                showToast('Masukkan nomor barcode!', 'error');
                return;
            }
            
            processBarcode(barcode);
            document.getElementById('manualBarcode').value = '';
        }

        function fillManual(code) {
            document.getElementById('manualBarcode').value = code;
            processManualInput();
        }

        function addAttendance(barcode, name, studentClass, major, status = 'hadir') {
            if (!db) return;
            
            const now = new Date();
            const data = {
                barcode: barcode,
                name: name,
                class: studentClass,
                major: major,
                date: getTodayString(),
                time: now.toLocaleTimeString('id-ID'),
                timestamp: now.getTime(),
                status: status,
                bolosTime: null,
                keterangan: '',
                operator: currentUser ? currentUser.name : 'Admin'
            };
            
            if (status === 'izin' || status === 'sakit') {
                data.time = '-';
            }
            
            const transaction = db.transaction(['attendance'], 'readwrite');
            const store = transaction.objectStore('attendance');
            
            store.add(data).onsuccess = (event) => {
                data.id = event.target.result;
                
                loadTodayData();
                updateStats();
                
                broadcastToFirebase('ADD', data);
                
                if (status === 'bolos' || status === 'izin' || status === 'sakit') {
                    notifyGuru(status, name, barcode);
                }
                
                if ('serviceWorker' in navigator && 'SyncManager' in window) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.sync.register('sync-attendance');
                    });
                }
            };
        }

        function loadTodayData() {
            if (!db || isStudentMode) return;
            
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(getTodayString());
            
            request.onsuccess = () => {
                const data = request.result || [];
                renderTable(data);
                updateStats();
            };
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-state">
                        <td colspan="8">
                            <i class="fas fa-inbox"></i>
                            <p>Belum ada data absensi</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const sortedData = [...data].sort((a, b) => {
                const statusOrder = { 'hadir': 0, 'bolos': 1, 'izin': 2, 'sakit': 3 };
                const orderA = statusOrder[a.status] || 0;
                const orderB = statusOrder[b.status] || 0;
                
                if (orderA !== orderB) {
                    return orderA - orderB;
                }
                return (a.timestamp || 0) - (b.timestamp || 0);
            });
            
            tbody.innerHTML = sortedData.map((item, index) => {
                const statusBadge = getStatusBadge(item.status);
                const rowClass = item.status === 'bolos' ? 'bolos' : item.status === 'izin' ? 'izin' : item.status === 'sakit' ? 'sakit' : '';
                
                return `
                <tr style="animation-delay: ${index * 0.05}s" class="${rowClass}">
                    <td>${index + 1}</td>
                    <td><strong>${item.name}</strong></td>
                    <td>${item.class}</td>
                    <td>${item.major}</td>
                    <td><span class="badge badge-time"><i class="fas fa-clock"></i> ${item.time}</span></td>
                    <td>${statusBadge}</td>
                    <td>
                        ${item.bolosTime 
                            ? `<span class="badge badge-danger"><i class="fas fa-clock"></i> ${item.bolosTime}</span>` 
                            : '-'
                        }
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.3rem;">
                            ${getActionButtons(item)}
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'hadir':
                    return '<span class="badge badge-success"><i class="fas fa-check"></i> Hadir</span>';
                case 'bolos':
                    return '<span class="badge badge-danger"><i class="fas fa-user-slash"></i> Bolos</span>';
                case 'izin':
                    return '<span class="badge badge-purple"><i class="fas fa-envelope"></i> Izin</span>';
                case 'sakit':
                    return '<span class="badge badge-orange"><i class="fas fa-notes-medical"></i> Sakit</span>';
                default:
                    return '<span class="badge badge-success"><i class="fas fa-check"></i> Hadir</span>';
            }
        }

        function getActionButtons(item) {
            let buttons = '';
            buttons += `<button class="btn-bolos" onclick="openStatusModal(${item.id})" title="Ubah Status" style="color: var(--primary);">
                <i class="fas fa-exchange-alt"></i>
            </button>`;
            buttons += `<button class="btn-delete" onclick="deleteEntry(${item.id})" title="Hapus">
                <i class="fas fa-trash-alt"></i>
            </button>`;
            return buttons;
        }

        function updateStats() {
            if (!db || isStudentMode) return;
            
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(getTodayString());
            
            request.onsuccess = () => {
                const data = request.result || [];
                const hadirCount = data.filter(item => item.status === 'hadir').length;
                const bolosCount = data.filter(item => item.status === 'bolos').length;
                const izinCount = data.filter(item => item.status === 'izin').length;
                const sakitCount = data.filter(item => item.status === 'sakit').length;
                
                document.getElementById('totalStudents').textContent = `${hadirCount} H, ${bolosCount} B, ${izinCount} I, ${sakitCount} S`;
                
                const entriesWithTime = data.filter(item => item.time && item.time !== '-');
                if (entriesWithTime.length > 0) {
                    document.getElementById('lastScan').textContent = entriesWithTime[entriesWithTime.length - 1].time;
                } else {
                    document.getElementById('lastScan').textContent = '--:--';
                }
            };
        }

        function deleteEntry(id) {
            if (!db || isStudentMode) return;
            
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                const getTransaction = db.transaction(['attendance'], 'readonly');
                const getStore = getTransaction.objectStore('attendance');
                const getRequest = getStore.get(id);
                
                getRequest.onsuccess = () => {
                    const dataToDelete = getRequest.result;
                    
                    const deleteTransaction = db.transaction(['attendance'], 'readwrite');
                    const deleteStore = deleteTransaction.objectStore('attendance');
                    deleteStore.delete(id).onsuccess = () => {
                        loadTodayData();
                        
                        broadcastToFirebase('DELETE', dataToDelete);
                        
                        showToast('Data berhasil dihapus', 'success');
                    };
                };
            }
        }

        // ============================================
        // STATUS & MODAL FUNCTIONS
        // ============================================
        function openBolosModal(id) {
            currentBolosId = id;
            document.getElementById('bolosModal').classList.add('active');
        }

        function closeBolosModal() {
            document.getElementById('bolosModal').classList.remove('active');
            currentBolosId = null;
        }

        function confirmBolos() {
            if (!currentBolosId || !db) return;
            
            const transaction = db.transaction(['attendance'], 'readwrite');
            const store = transaction.objectStore('attendance');
            const request = store.get(currentBolosId);
            
            request.onsuccess = () => {
                const data = request.result;
                if (data) {
                    data.status = 'bolos';
                    data.bolosTime = new Date().toLocaleTimeString('id-ID');
                    
                    store.put(data).onsuccess = () => {
                        loadTodayData();
                        
                        broadcastToFirebase('UPDATE', data);
                        
                        notifyGuru('bolos', data.name, data.barcode);
                        showToast(`Siswa ${data.name} ditandai sebagai bolos`, 'warning');
                        closeBolosModal();
                    };
                }
            };
        }

        function openStatusModal(id) {
            currentStatusId = id;
            selectedNewStatus = null;
            document.getElementById('statusModal').classList.add('active');
            
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.remove('active');
            currentStatusId = null;
            selectedNewStatus = null;
        }

        function selectStatus(status) {
            selectedNewStatus = status;
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.status-option.${status}`).classList.add('selected');
        }

        function confirmStatusChange() {
            if (!currentStatusId || !selectedNewStatus || !db) {
                showToast('Pilih status terlebih dahulu!', 'error');
                return;
            }
            
            const transaction = db.transaction(['attendance'], 'readwrite');
            const store = transaction.objectStore('attendance');
            const request = store.get(currentStatusId);
            
            request.onsuccess = () => {
                const data = request.result;
                if (data) {
                    const oldStatus = data.status;
                    data.status = selectedNewStatus;
                    
                    if (selectedNewStatus === 'izin' || selectedNewStatus === 'sakit') {
                        data.time = '-';
                        data.bolosTime = null;
                    } else if (selectedNewStatus === 'bolos') {
                        data.bolosTime = new Date().toLocaleTimeString('id-ID');
                    } else if (selectedNewStatus === 'hadir' && (oldStatus === 'izin' || oldStatus === 'sakit')) {
                        data.time = new Date().toLocaleTimeString('id-ID');
                        data.bolosTime = null;
                    }
                    
                    store.put(data).onsuccess = () => {
                        loadTodayData();
                        
                        broadcastToFirebase('UPDATE', data);
                        
                        if (selectedNewStatus === 'bolos' || selectedNewStatus === 'izin' || selectedNewStatus === 'sakit') {
                            notifyGuru(selectedNewStatus, data.name, data.barcode);
                        }
                        
                        showToast(`Status ${data.name} berhasil diubah menjadi ${selectedNewStatus}`, 'success');
                        closeStatusModal();
                    };
                }
            };
        }

        function openQuickAddModal(status) {
            currentQuickStatus = status;
            const titleSpan = document.getElementById('quickAddStatusTitle');
            const statusInput = document.getElementById('quickStatus');
            
            const statusText = {
                'hadir': 'Hadir',
                'bolos': 'Bolos',
                'izin': 'Izin',
                'sakit': 'Sakit'
            };
            titleSpan.textContent = statusText[status] || status;
            statusInput.value = status;
            
            document.getElementById('quickAddModal').classList.add('active');
        }

        function closeQuickAddModal() {
            document.getElementById('quickAddModal').classList.remove('active');
            document.getElementById('quickAddForm').reset();
            currentQuickStatus = null;
        }

        function saveQuickAdd(e) {
            e.preventDefault();
            
            const barcode = document.getElementById('quickBarcode').value.trim();
            let name = document.getElementById('quickName').value.trim();
            const studentClass = document.getElementById('quickClass').value;
            const major = document.getElementById('quickMajor').value;
            const status = document.getElementById('quickStatus').value;
            
            if (!barcode) {
                showToast('Masukkan nomor barcode!', 'error');
                return;
            }
            
            const student = studentDatabase[barcode];
            if (student && !name) {
                name = student.name;
            }
            
            if (!name) {
                showToast('Masukkan nama siswa!', 'error');
                return;
            }
            
            if (!db) return;
            
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(getTodayString());
            
            request.onsuccess = () => {
                const todayData = request.result || [];
                const existing = todayData.find(item => item.barcode === barcode);
                
                if (existing) {
                    showToast('Siswa dengan barcode ini sudah ada hari ini!', 'error');
                    return;
                }
                
                addAttendance(barcode, name, studentClass, major, status);
                closeQuickAddModal();
                showToast(`Data berhasil ditambahkan dengan status ${status}!`, 'success');
            };
        }

        // ============================================
        // REKAP & RIWAYAT FUNCTIONS
        // ============================================
        function loadRekapBulanan() {
            if (!db || isStudentMode) return;
            
            const bulan = parseInt(document.getElementById('rekapBulan').value);
            const tahun = parseInt(document.getElementById('rekapTahun').value);
            
            const transaction = db.transaction(['attendance', 'attendanceHistory'], 'readonly');
            const store = transaction.objectStore('attendance');
            const historyStore = transaction.objectStore('attendanceHistory');
            
            const request = store.getAll();
            const historyRequest = historyStore.getAll();
            
            Promise.all([
                new Promise((resolve) => { request.onsuccess = () => resolve(request.result || []); }),
                new Promise((resolve) => { historyRequest.onsuccess = () => resolve(historyRequest.result || []); })
            ]).then(([currentData, historyData]) => {
                const allData = [...currentData, ...historyData];
                
                const filteredData = allData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate.getMonth() === bulan && itemDate.getFullYear() === tahun;
                });
                
                renderRekap(filteredData, bulan, tahun);
                renderRanking(filteredData);
            });
        }

        function renderRekap(data, bulan, tahun) {
            const container = document.getElementById('rekapContainer');
            
            const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const totalHari = new Set(data.map(item => item.date)).size;
            const totalSiswa = Object.keys(studentDatabase).length;
            
            const hadir = data.filter(item => item.status === 'hadir').length;
            const bolos = data.filter(item => item.status === 'bolos').length;
            const izin = data.filter(item => item.status === 'izin').length;
            const sakit = data.filter(item => item.status === 'sakit').length;
            const total = data.length;
            
            const persenHadir = total > 0 ? ((hadir / total) * 100).toFixed(1) : 0;
            const persenBolos = total > 0 ? ((bolos / total) * 100).toFixed(1) : 0;
            const persenIzin = total > 0 ? ((izin / total) * 100).toFixed(1) : 0;
            const persenSakit = total > 0 ? ((sakit / total) * 100).toFixed(1) : 0;
            
            container.innerHTML = `
                <div class="rekap-card">
                    <div class="rekap-header">
                        <span class="rekap-title">Periode</span>
                        <span style="font-weight: 700; color: var(--primary);">${namaBulan[bulan]} ${tahun}</span>
                    </div>
                    <div class="rekap-item">
                        <span class="rekap-label">Total Hari Efektif</span>
                        <span class="rekap-value">${totalHari} hari</span>
                    </div>
                    <div class="rekap-item">
                        <span class="rekap-label">Total Siswa</span>
                        <span class="rekap-value">${totalSiswa} siswa</span>
                    </div>
                    <div class="rekap-item">
                        <span class="rekap-label">Total Records</span>
                        <span class="rekap-value">${total} data</span>
                    </div>
                </div>
                
                <div class="rekap-card">
                    <div class="rekap-header">
                        <span class="rekap-title">Hadir</span>
                        <span style="font-weight: 700; color: var(--success);">${persenHadir}%</span>
                    </div>
                    <div class="rekap-item">
                        <span class="rekap-label">Jumlah</span>
                        <span class="rekap-value" style="color: var(--success);">${hadir}</span>
                    </div>
                    <div class="rekap-bar">
                        <div class="rekap-fill" style="width: ${persenHadir}%; background: var(--success);"></div>
                    </div>
                </div>
                
                <div class="rekap-card">
                    <div class="rekap-header">
                        <span class="rekap-title">Izin</span>
                        <span style="font-weight: 700; color: var(--purple);">${persenIzin}%</span>
                    </div>
                    <div class="rekap-item">
                        <span class="rekap-label">Jumlah</span>
                        <span class="rekap-value" style="color: var(--purple);">${izin}</span>
                    </div>
                    <div class="rekap-bar">
                        <div class="rekap-fill" style="width: ${persenIzin}%; background: var(--purple);"></div>
                    </div>
                </div>
                
                <div class="rekap-card">
                    <div class="rekap-header">
                        <span class="rekap-title">Sakit</span>
                        <span style="font-weight: 700; color: var(--orange);">${persenSakit}%</span>
                    </div>
                    <div class="rekap-item">
                        <span class="rekap-label">Jumlah</span>
                        <span class="rekap-value" style="color: var(--orange);">${sakit}</span>
                    </div>
                    <div class="rekap-bar">
                        <div class="rekap-fill" style="width: ${persenSakit}%; background: var(--orange);"></div>
                    </div>
                </div>
                
                <div class="rekap-card">
                    <div class="rekap-header">
                        <span class="rekap-title">Bolos</span>
                        <span style="font-weight: 700; color: var(--danger);">${persenBolos}%</span>
                    </div>
                    <div class="rekap-item">
                        <span class="rekap-label">Jumlah</span>
                        <span class="rekap-value" style="color: var(--danger);">${bolos}</span>
                    </div>
                    <div class="rekap-bar">
                        <div class="rekap-fill" style="width: ${persenBolos}%; background: var(--danger);"></div>
                    </div>
                </div>
            `;
        }

        function renderRanking(data) {
            const tbody = document.getElementById('rankingBody');
            
            const studentStats = {};
            
            data.forEach(item => {
                if (!studentStats[item.barcode]) {
                    studentStats[item.barcode] = {
                        name: item.name,
                        class: item.class,
                        hadir: 0,
                        izin: 0,
                        sakit: 0,
                        bolos: 0,
                        total: 0
                    };
                }
                
                studentStats[item.barcode][item.status]++;
                studentStats[item.barcode].total++;
            });
            
            const ranking = Object.entries(studentStats).map(([barcode, stats]) => ({
                barcode,
                ...stats,
                percentage: stats.total > 0 ? ((stats.hadir / stats.total) * 100).toFixed(1) : 0
            }));
            
            ranking.sort((a, b) => b.percentage - a.percentage);
            
            if (ranking.length === 0) {
                tbody.innerHTML = '<tr class="empty-state"><td colspan="9">Belum ada data untuk periode ini</td></tr>';
                return;
            }
            
            tbody.innerHTML = ranking.map((item, index) => {
                let rankBadge = '';
                if (index === 0) rankBadge = '';
                else if (index === 1) rankBadge = '';
                else if (index === 2) rankBadge = '';
                else rankBadge = `${index + 1}`;
                
                let statusClass = '';
                let statusText = '';
                if (item.percentage >= 90) {
                    statusClass = 'badge-success';
                    statusText = 'Sangat Baik';
                } else if (item.percentage >= 75) {
                    statusClass = 'badge-warning';
                    statusText = 'Baik';
                } else {
                    statusClass = 'badge-danger';
                    statusText = 'Kurang';
                }
                
                return `
                    <tr>
                        <td style="text-align: center; font-weight: 700;">${rankBadge}</td>
                        <td><strong>${item.name}</strong></td>
                        <td>${item.class}</td>
                        <td>${item.hadir}</td>
                        <td>${item.izin}</td>
                        <td>${item.sakit}</td>
                        <td>${item.bolos}</td>
                        <td style="font-weight: 700;">${item.percentage}%</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function exportRekapToExcel() {
            if (!db || isStudentMode) return;
            
            const bulan = parseInt(document.getElementById('rekapBulan').value);
            const tahun = parseInt(document.getElementById('rekapTahun').value);
            const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const transaction = db.transaction(['attendance', 'attendanceHistory'], 'readonly');
            const store = transaction.objectStore('attendance');
            const historyStore = transaction.objectStore('attendanceHistory');
            
            const request = store.getAll();
            const historyRequest = historyStore.getAll();
            
            Promise.all([
                new Promise((resolve) => { request.onsuccess = () => resolve(request.result || []); }),
                new Promise((resolve) => { historyRequest.onsuccess = () => resolve(historyRequest.result || []); })
            ]).then(([currentData, historyData]) => {
                const allData = [...currentData, ...historyData];
                const filteredData = allData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate.getMonth() === bulan && itemDate.getFullYear() === tahun;
                });
                
                if (filteredData.length === 0) {
                    showToast('Tidak ada data untuk periode ini!', 'error');
                    return;
                }
                
                const studentStats = {};
                filteredData.forEach(item => {
                    if (!studentStats[item.barcode]) {
                        studentStats[item.barcode] = {
                            Nama: item.name,
                            Kelas: item.class,
                            Jurusan: item.major,
                            Hadir: 0,
                            Izin: 0,
                            Sakit: 0,
                            Bolos: 0,
                            Total: 0
                        };
                    }
                    studentStats[item.barcode][item.status.charAt(0).toUpperCase() + item.status.slice(1)]++;
                    studentStats[item.barcode].Total++;
                });
                
                const excelData = Object.values(studentStats).map(item => ({
                    ...item,
                    Persentase: ((item.Hadir / item.Total) * 100).toFixed(1) + '%'
                }));
                
                const ws = XLSX.utils.json_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 25 }, { wch: 10 }, { wch: 10 }, { wch: 8 }, 
                    { wch: 8 }, { wch: 8 }, { wch: 8 }, { wch: 8 }, { wch: 12 }
                ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rekap Bulanan");
                
                const filename = `Rekap_Absensi_${namaBulan[bulan]}_${tahun}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showToast(`File ${filename} berhasil diunduh!`, 'success');
            });
        }

        function searchRiwayat() {
            if (isStudentMode) return;
            
            const searchTerm = document.getElementById('riwayatSearch').value.trim().toLowerCase();
            
            if (!searchTerm) {
                showToast('Masukkan nama atau barcode siswa!', 'error');
                return;
            }
            
            let foundStudent = null;
            let foundBarcode = null;
            
            for (const [barcode, data] of Object.entries(studentDatabase)) {
                if (barcode.toLowerCase() === searchTerm || 
                    data.name.toLowerCase().includes(searchTerm)) {
                    foundStudent = data;
                    foundBarcode = barcode;
                    break;
                }
            }
            
            if (!foundStudent) {
                showToast('Siswa tidak ditemukan!', 'error');
                return;
            }
            
            loadRiwayatSiswa(foundBarcode, foundStudent);
        }

        function loadRiwayatSiswa(barcode, studentData) {
            if (!db) return;
            
            const transaction = db.transaction(['attendance', 'studentHistory'], 'readonly');
            const store = transaction.objectStore('attendance');
            const historyStore = transaction.objectStore('studentHistory');
            
            const index = store.index('barcode');
            const historyIndex = historyStore.index('barcode');
            
            const request = index.getAll(barcode);
            const historyRequest = historyIndex.getAll(barcode);
            
            Promise.all([
                new Promise((resolve) => { request.onsuccess = () => resolve(request.result || []); }),
                new Promise((resolve) => { historyRequest.onsuccess = () => resolve(historyRequest.result || []); })
            ]).then(([currentData, historyData]) => {
                const allData = [...currentData, ...historyData];
                allData.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderRiwayat(barcode, studentData, allData);
            });
        }

        function renderRiwayat(barcode, studentData, data) {
            const resultDiv = document.getElementById('riwayatResult');
            const emptyDiv = document.getElementById('riwayatEmpty');
            
            emptyDiv.classList.add('hidden');
            resultDiv.classList.remove('hidden');
            
            const hadir = data.filter(item => item.status === 'hadir').length;
            const izin = data.filter(item => item.status === 'izin').length;
            const sakit = data.filter(item => item.status === 'sakit').length;
            const bolos = data.filter(item => item.status === 'bolos').length;
            const total = data.length;
            const percentage = total > 0 ? ((hadir / total) * 100).toFixed(1) : 0;
            
            const now = new Date();
            const calendarHTML = generateCalendar(data, now.getMonth(), now.getFullYear());
            
            resultDiv.innerHTML = `
                <div class="riwayat-header">
                    <div class="riwayat-avatar">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="riwayat-name">${studentData.name}</div>
                    <div class="riwayat-info">
                        ${studentData.class} ${studentData.major} | Barcode: ${barcode}
                    </div>
                </div>
                
                <div class="riwayat-stats">
                    <div class="riwayat-stat">
                        <div class="riwayat-stat-value" style="color: var(--success);">${hadir}</div>
                        <div class="riwayat-stat-label">Hadir</div>
                    </div>
                    <div class="riwayat-stat">
                        <div class="riwayat-stat-value" style="color: var(--purple);">${izin}</div>
                        <div class="riwayat-stat-label">Izin</div>
                    </div>
                    <div class="riwayat-stat">
                        <div class="riwayat-stat-value" style="color: var(--orange);">${sakit}</div>
                        <div class="riwayat-stat-label">Sakit</div>
                    </div>
                    <div class="riwayat-stat">
                        <div class="riwayat-stat-value" style="color: var(--danger);">${bolos}</div>
                        <div class="riwayat-stat-label">Bolos</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary-dark);">${percentage}%</div>
                    <div style="color: #64748b;">Persentase Kehadiran</div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-dark);">
                        <i class="fas fa-calendar-alt"></i> Kalender Absensi Bulan Ini
                    </h4>
                    ${calendarHTML}
                </div>
                
                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--primary-dark);">
                        <i class="fas fa-list"></i> Riwayat Lengkap (${data.length} records)
                    </h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Status</th>
                                    <th>Waktu</th>
                                    <th>Operator</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(item => `
                                    <tr>
                                        <td>${formatDate(item.date)}</td>
                                        <td>${getStatusBadge(item.status)}</td>
                                        <td>${item.time}</td>
                                        <td>${item.operator || 'Admin'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ============================================
        // FUNGSI LOAD STUDENT OWN RIWAYAT (MODIFIKASI)
        // ============================================
        function loadStudentOwnRiwayat() {
            if (!isStudentMode || !currentStudentBarcode) return;
            
            const studentData = studentDatabase[currentStudentBarcode];
            if (!studentData) return;
            
            const container = document.getElementById('studentRiwayatContent');
            container.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Memuat data...</p></div>';
            
            if (!db) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Database belum siap</p></div>';
                return;
            }
            
            const transaction = db.transaction(['attendance', 'studentHistory'], 'readonly');
            const store = transaction.objectStore('attendance');
            const historyStore = transaction.objectStore('studentHistory');
            
            const index = store.index('barcode');
            const historyIndex = historyStore.index('barcode');
            
            const request = index.getAll(currentStudentBarcode);
            const historyRequest = historyIndex.getAll(currentStudentBarcode);
            
            Promise.all([
                new Promise((resolve) => { request.onsuccess = () => resolve(request.result || []); }),
                new Promise((resolve) => { historyRequest.onsuccess = () => resolve(historyRequest.result || []); })
            ]).then(([currentData, historyData]) => {
                const allData = [...currentData, ...historyData];
                allData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // MODIFIKASI: Untuk tampilan siswa, ubah status 'bolos' menjadi 'hadir'
                const modifiedData = allData.map(item => ({
                    ...item,
                    // Ganti status untuk tampilan saja
                    displayStatus: item.status === 'bolos' ? 'hadir' : item.status
                }));
                
                const hadir = modifiedData.filter(item => item.displayStatus === 'hadir').length;
                const izin = modifiedData.filter(item => item.displayStatus === 'izin').length;
                const sakit = modifiedData.filter(item => item.displayStatus === 'sakit').length;
                const bolos = modifiedData.filter(item => item.displayStatus === 'bolos').length; // bolos asli sudah jadi hadir, jadi ini akan 0
                const total = allData.length;
                const percentage = total > 0 ? ((hadir / total) * 100).toFixed(1) : 0;
                
                const now = new Date();
                // Untuk kalender, kita juga harus menampilkan berdasarkan status asli? Atau kita tampilkan hadir semua?
                // Lebih baik kalender tetap menampilkan status asli? Tapi permintaan "di tampilan dia, dia sudah hadir" berarti semua bolos harus tampil hadir.
                // Jadi kita buat kalender berdasarkan displayStatus.
                const calendarHTML = generateStudentCalendar(modifiedData, now.getMonth(), now.getFullYear());
                
                container.innerHTML = `
                    <div class="riwayat-result">
                        <div class="riwayat-header">
                            <div class="riwayat-avatar">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="riwayat-name">${studentData.name}</div>
                            <div class="riwayat-info">
                                ${studentData.class} ${studentData.major} | Barcode: ${currentStudentBarcode}
                            </div>
                        </div>
                        
                        <div class="riwayat-stats">
                            <div class="riwayat-stat">
                                <div class="riwayat-stat-value" style="color: var(--success);">${hadir}</div>
                                <div class="riwayat-stat-label">Hadir</div>
                            </div>
                            <div class="riwayat-stat">
                                <div class="riwayat-stat-value" style="color: var(--purple);">${izin}</div>
                                <div class="riwayat-stat-label">Izin</div>
                            </div>
                            <div class="riwayat-stat">
                                <div class="riwayat-stat-value" style="color: var(--orange);">${sakit}</div>
                                <div class="riwayat-stat-label">Sakit</div>
                            </div>
                            <div class="riwayat-stat">
                                <div class="riwayat-stat-value" style="color: var(--danger);">${bolos}</div>
                                <div class="riwayat-stat-label">Bolos</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-dark);">${percentage}%</div>
                            <div style="color: #64748b;">Persentase Kehadiran</div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 1rem; color: var(--primary-dark);">
                                <i class="fas fa-calendar-alt"></i> Kalender Absensi Bulan Ini
                            </h4>
                            ${calendarHTML}
                        </div>
                        
                        <div>
                            <h4 style="margin-bottom: 1rem; color: var(--primary-dark);">
                                <i class="fas fa-list"></i> Riwayat Lengkap (${allData.length} records)
                            </h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Status</th>
                                            <th>Waktu</th>
                                            <th>Operator</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allData.length === 0 ? `
                                            <tr class="empty-state">
                                                <td colspan="4">
                                                    <i class="fas fa-inbox"></i>
                                                    <p>Belum ada data absensi</p>
                                                </td>
                                            </tr>
                                        ` : allData.map(item => {
                                            // Tampilkan status yang sudah dimodifikasi
                                            const displayStatus = item.status === 'bolos' ? 'hadir' : item.status;
                                            return `
                                                <tr>
                                                    <td>${formatDate(item.date)}</td>
                                                    <td>${getStatusBadge(displayStatus)}</td>
                                                    <td>${item.time}</td>
                                                    <td>${item.operator || 'Admin'}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }).catch(() => {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Gagal memuat data</p></div>';
            });
        }

        // Fungsi untuk generate kalender dengan status yang sudah dimodifikasi
        function generateStudentCalendar(data, month, year) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            
            const statusByDate = {};
            data.forEach(item => {
                const date = new Date(item.date);
                if (date.getMonth() === month && date.getFullYear() === year) {
                    // Gunakan displayStatus jika ada, atau status asli
                    const displayStatus = item.displayStatus || (item.status === 'bolos' ? 'hadir' : item.status);
                    statusByDate[date.getDate()] = displayStatus;
                }
            });
            
            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            
            let html = '<div class="calendar-header">';
            days.forEach(day => {
                html += `<div>${day}</div>`;
            });
            html += '</div>';
            
            html += '<div class="riwayat-calendar">';
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const status = statusByDate[day];
                let className = 'calendar-day';
                if (status) {
                    className += ` ${status}`;
                } else {
                    className += ' empty';
                }
                html += `<div class="${className}" title="${status || 'Tidak ada data'}">${day}</div>`;
            }
            
            html += '</div>';
            
            return html;
        }

        function generateCalendar(data, month, year) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            
            const statusByDate = {};
            data.forEach(item => {
                const date = new Date(item.date);
                if (date.getMonth() === month && date.getFullYear() === year) {
                    statusByDate[date.getDate()] = item.status;
                }
            });
            
            const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            
            let html = '<div class="calendar-header">';
            days.forEach(day => {
                html += `<div>${day}</div>`;
            });
            html += '</div>';
            
            html += '<div class="riwayat-calendar">';
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const status = statusByDate[day];
                let className = 'calendar-day';
                if (status) {
                    className += ` ${status}`;
                } else {
                    className += ' empty';
                }
                html += `<div class="${className}" title="${status || 'Tidak ada data'}">${day}</div>`;
            }
            
            html += '</div>';
            
            return html;
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // ============================================
        // EXPORT & UTILITY FUNCTIONS
        // ============================================
        function exportToExcel() {
            if (!db || isStudentMode) return;
            
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(getTodayString());
            
            request.onsuccess = () => {
                const data = request.result || [];
                
                if (data.length === 0) {
                    showToast('Tidak ada data untuk diekspor!', 'error');
                    return;
                }
                
                const hadirBolos = data.filter(item => item.status === 'hadir' || item.status === 'bolos');
                const izinSakit = data.filter(item => item.status === 'izin' || item.status === 'sakit');
                
                hadirBolos.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                izinSakit.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                
                const excelDataHadirBolos = hadirBolos.map((item, index) => ({
                    'No': index + 1,
                    'Nama_Siswa': item.name,
                    'Kelas': item.class,
                    'Jurusan': item.major,
                    'Tanggal': item.date,
                    'Waktu_Hadir': item.time,
                    'Status': item.status === 'bolos' ? 'BOL' : 'HADIR',
                    'Waktu_Bolos': item.bolosTime || '-',
                    'Barcode': item.barcode,
                    'Operator': item.operator || 'Admin'
                }));
                
                const excelDataIzinSakit = izinSakit.map((item, index) => ({
                    'No': hadirBolos.length + index + 1,
                    'Nama_Siswa': item.name,
                    'Kelas': item.class,
                    'Jurusan': item.major,
                    'Tanggal': item.date,
                    'Waktu_Hadir': '',
                    'Status': item.status === 'izin' ? 'IZIN' : 'SAKIT',
                    'Waktu_Bolos': '-',
                    'Barcode': item.barcode,
                    'Operator': item.operator || 'Admin'
                }));
                
                const allData = [...excelDataHadirBolos, ...excelDataIzinSakit];
                
                const ws = XLSX.utils.json_to_sheet(allData);
                
                ws['!cols'] = [
                    { wch: 5 },
                    { wch: 25 },
                    { wch: 10 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 10 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 15 }
                ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Absensi");
                
                const filename = `Absensi_12RPL_${getTodayString()}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                showToast(`File ${filename} berhasil diunduh!`, 'success');
            };
        }

        function clearAllData() {
            if (!db || isStudentMode) return;
            
            if (confirm('PERINGATAN: Ini akan menghapus SEMUA data absensi hari ini! Lanjutkan?')) {
                const transaction = db.transaction(['attendance'], 'readwrite');
                const store = transaction.objectStore('attendance');
                const index = store.index('date');
                const request = index.openCursor(IDBKeyRange.only(getTodayString()));
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        store.delete(cursor.primaryKey);
                        cursor.continue();
                    } else {
                        loadTodayData();
                        
                        if (firebaseDB && isOnline) {
                            firebaseDB.ref(`attendance/${getTodayString()}`).remove();
                        }
                        
                        broadcastToLocalStorage('DELETE_ALL', { date: getTodayString() });
                        showToast('Semua data hari ini telah dihapus', 'success');
                    }
                };
            }
        }

        function loadSampleData() {
            if (isStudentMode) return;
            
            const samples = [
                { barcode: 'RPL1009', name: 'Kania Putri Dewi', class: 'XII', major: 'RPL', status: 'hadir' },
                { barcode: 'RPL2013', name: 'Padli Nurramadhan', class: 'XII', major: 'RPL', status: 'hadir' },
                { barcode: 'RPL1001', name: 'Ade Pajriah', class: 'XII', major: 'RPL', status: 'izin' },
                { barcode: 'RPL2001', name: 'Ade Amelia Rizkiyah', class: 'XII', major: 'RPL', status: 'sakit' }
            ];
            
            let added = 0;
            samples.forEach((student, index) => {
                setTimeout(() => {
                    addAttendance(student.barcode, student.name, student.class, student.major, student.status);
                    added++;
                    if (added === samples.length) {
                        showToast('Data sample berhasil dimuat!', 'success');
                    }
                }, index * 200);
            });
        }

        // ============================================
        // MODAL & UI FUNCTIONS
        // ============================================
        function openModal() {
            if (isStudentMode) {
                showToast('Siswa tidak dapat menambah data!', 'error');
                return;
            }
            document.getElementById('addModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('addForm').reset();
        }

        function saveManualEntry(e) {
            e.preventDefault();
            
            if (isStudentMode) {
                showToast('Siswa tidak dapat menambah data!', 'error');
                return;
            }
            
            const barcode = document.getElementById('modalBarcode').value;
            const name = document.getElementById('modalName').value;
            const studentClass = document.getElementById('modalClass').value;
            const major = document.getElementById('modalMajor').value;
            const status = document.getElementById('modalStatus').value;
            
            if (!db) return;
            
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(getTodayString());
            
            request.onsuccess = () => {
                const todayData = request.result || [];
                const existing = todayData.find(item => item.barcode === barcode);
                
                if (existing) {
                    showToast('Siswa dengan barcode ini sudah absen hari ini!', 'error');
                    return;
                }
                
                addAttendance(barcode, name, studentClass, major, status);
                closeModal();
                showToast('Data berhasil ditambahkan!', 'success');
            };
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'check-circle',
                error: 'times-circle',
                warning: 'exclamation-circle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas fa-${icons[type]} toast-icon"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        function playBeep() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const audioContext = new AudioContext();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        window.onclick = function(event) {
            const modals = ['addModal', 'bolosModal', 'profileModal', 'guideModal', 'quickAddModal', 'statusModal', 'fingerprintModal', 'chatModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.classList.remove('active');
                    if (modalId === 'chatModal') {
                        closeChatModal();
                    }
                }
            });
        }

        // ============================================
        // GUIDE FUNCTIONS
        // ============================================
        function initGuide() {
            const rpl1List = document.getElementById('guideListRPL1');
            const rpl2List = document.getElementById('guideListRPL2');
            
            if (!rpl1List || !rpl2List) return;
            
            const rpl1Students = Object.entries(studentDatabase)
                .filter(([code, data]) => code.startsWith('RPL1'))
                .sort((a, b) => a[0].localeCompare(b[0]));
            
            const rpl2Students = Object.entries(studentDatabase)
                .filter(([code, data]) => code.startsWith('RPL2'))
                .sort((a, b) => a[0].localeCompare(b[0]));
            
            rpl1List.innerHTML = rpl1Students.map(([code, data]) => `
                <div class="guide-item" data-name="${data.name.toLowerCase()}" data-code="${code.toLowerCase()}">
                    <div class="guide-item-info">
                        <span class="guide-item-name">${data.name}</span>
                        <span class="guide-item-code">${code}</span>
                    </div>
                    <button class="guide-item-copy" onclick="copyToClipboard('${code}')" title="Copy kode">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            `).join('');
            
            rpl2List.innerHTML = rpl2Students.map(([code, data]) => `
                <div class="guide-item" data-name="${data.name.toLowerCase()}" data-code="${code.toLowerCase()}">
                    <div class="guide-item-info">
                        <span class="guide-item-name">${data.name}</span>
                        <span class="guide-item-code">${code}</span>
                    </div>
                    <button class="guide-item-copy" onclick="copyToClipboard('${code}')" title="Copy kode">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            `).join('');
            
            updateGuideStats();
        }

        function updateGuideStats() {
            const rpl1Count = Object.keys(studentDatabase).filter(code => code.startsWith('RPL1')).length;
            const rpl2Count = Object.keys(studentDatabase).filter(code => code.startsWith('RPL2')).length;
            const totalCount = Object.keys(studentDatabase).length;
            
            document.getElementById('totalStudentsCount').textContent = totalCount;
            document.getElementById('rpl1Count').textContent = rpl1Count;
            document.getElementById('rpl2Count').textContent = rpl2Count;
        }

        function filterGuide() {
            const searchTerm = document.getElementById('guideSearch').value.toLowerCase();
            const items = document.querySelectorAll('.guide-item');
            
            items.forEach(item => {
                const name = item.getAttribute('data-name');
                const code = item.getAttribute('data-code');
                
                if (name.includes(searchTerm) || code.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`Kode ${text} berhasil disalin!`, 'success');
            }).catch(() => {
                showToast('Gagal menyalin kode', 'error');
            });
        }

        function openGuideModal() {
            document.getElementById('guideModal').classList.add('active');
            initGuide();
        }

        function closeGuideModal() {
            document.getElementById('guideModal').classList.remove('active');
        }

        function openProfileModal() {
            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabBtn = document.getElementById('tab-' + tabName) || document.getElementById('tab-student-' + tabName);
            if (tabBtn) tabBtn.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            const content = document.getElementById('content-' + tabName);
            if (content) content.classList.remove('hidden');
            
            if (tabName !== 'absensi' && isScanning) {
                stopScanner();
            }
            
            if (tabName === 'rekap') {
                loadRekapBulanan();
            } else if (tabName === 'studentRiwayat') {
                loadStudentOwnRiwayat();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'backup') {
                loadBackupHistory();
            }
        }

        // ============================================
        // WHATSAPP NOTIFICATION
        // ============================================
        function sendWhatsAppNotification(message) {
            const formattedNumber = GURU_WHATSAPP.startsWith('0') ? 
                '62' + GURU_WHATSAPP.substring(1) : GURU_WHATSAPP;
            const whatsappURL = `https://wa.me/${formattedNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappURL, '_blank');
        }

        function notifyGuru(status, studentName, barcode) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID');
            const dateStr = now.toLocaleDateString('id-ID');
            
            let message = `*NOTIFIKASI ABSENSI*\\n\\n`;
            message += `Tanggal: ${dateStr}\\n`;
            message += `Waktu: ${timeStr}\\n`;
            message += `Operator: ${currentUser ? currentUser.name : 'Admin'}\\n\\n`;
            
            if (status === 'bolos') {
                message += ` *SISWA BOLOS*\\n`;
                message += `Nama: ${studentName}\\n`;
                message += `Barcode: ${barcode}\\n\\n`;
                message += `Mohon tindak lanjutnya.`;
            } else if (status === 'izin') {
                message += ` *SISWA IZIN*\\n`;
                message += `Nama: ${studentName}\\n`;
                message += `Barcode: ${barcode}\\n\\n`;
                message += `Status: Izin`;
            } else if (status === 'sakit') {
                message += ` *SISWA SAKIT*\\n`;
                message += `Nama: ${studentName}\\n`;
                message += `Barcode: ${barcode}\\n\\n`;
                message += `Status: Sakit`;
            }
            
            sendWhatsAppNotification(message);
        }

        // ============================================
        // BARCODE GENERATOR FUNCTIONS
        // ============================================
        function setFormat(format) {
            currentFormat = format;
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            previewBarcode();
        }

        function previewBarcode() {
            const barcode = document.getElementById('genBarcode').value;
            const name = document.getElementById('genName').value;
            const previewContainer = document.getElementById('previewContainer');
            
            if (!barcode) {
                previewContainer.innerHTML = `
                    <i class="fas fa-barcode" style="font-size: 4rem; color: var(--gray-200);"></i>
                    <p style="color: #94a3b8; margin-top: 1rem;">Masukkan data untuk generate barcode</p>
                `;
                return;
            }
            
            try {
                const canvas = document.createElement('canvas');
                JsBarcode(canvas, barcode, {
                    format: currentFormat,
                    width: 2,
                    height: 80,
                    displayValue: true,
                    fontSize: 16,
                    font: 'monospace',
                    margin: 10
                });
                
                previewContainer.innerHTML = '';
                
                const wrapper = document.createElement('div');
                wrapper.className = 'barcode-canvas';
                wrapper.appendChild(canvas);
                
                if (name) {
                    const nameLabel = document.createElement('div');
                    nameLabel.style.marginTop = '10px';
                    nameLabel.style.fontWeight = 'bold';
                    nameLabel.style.color = 'var(--primary-dark)';
                    nameLabel.textContent = name;
                    wrapper.appendChild(nameLabel);
                }
                
                previewContainer.appendChild(wrapper);
            } catch (e) {
                console.error('Barcode generation error:', e);
            }
        }

        function generateBarcode() {
            if (isStudentMode) {
                showToast('Siswa tidak dapat generate barcode!', 'error');
                return;
            }
            
            const barcode = document.getElementById('genBarcode').value;
            const name = document.getElementById('genName').value;
            const studentClass = document.getElementById('genClass').value;
            const major = document.getElementById('genMajor').value;
            
            if (!barcode) {
                showToast('Masukkan nomor barcode!', 'error');
                return;
            }
            
            const generatedData = {
                barcode: barcode,
                name: name || 'Unknown',
                class: studentClass,
                major: major,
                timestamp: new Date().getTime()
            };
            
            const existing = generatedBarcodes.find(item => item.barcode === barcode);
            if (existing) {
                showToast('Barcode sudah ada dalam daftar!', 'warning');
                return;
            }
            
            generatedBarcodes.push(generatedData);
            updateGeneratedList();
            showToast('Barcode berhasil digenerate!', 'success');
            
            document.getElementById('genBarcode').value = '';
            document.getElementById('genName').value = '';
            previewBarcode();
        }

        function updateGeneratedList() {
            const listContainer = document.getElementById('generatedList');
            const countSpan = document.getElementById('generatedCount');
            
            countSpan.textContent = generatedBarcodes.length;
            
            if (generatedBarcodes.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state" style="padding: 2rem;">
                        <i class="fas fa-inbox"></i>
                        <p>Belum ada barcode yang digenerate</p>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = generatedBarcodes.map((item, index) => `
                <div class="student-item">
                    <div class="student-info">
                        <span class="student-name">${item.name}</span>
                        <span class="student-id">${item.barcode}  ${item.class} ${item.major}</span>
                    </div>
                    <div style="display: flex; gap: 0.3rem;">
                        <button class="btn btn-primary btn-small" onclick="downloadSingleBarcode(${index})">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-danger btn-small" onclick="removeGenerated(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function removeGenerated(index) {
            if (isStudentMode) return;
            
            generatedBarcodes.splice(index, 1);
            updateGeneratedList();
            showToast('Barcode dihapus dari daftar', 'success');
        }

        function clearGenerated() {
            if (isStudentMode) return;
            
            if (generatedBarcodes.length === 0) return;
            
            if (confirm('Hapus semua barcode yang sudah digenerate?')) {
                generatedBarcodes = [];
                updateGeneratedList();
                showToast('Daftar barcode dikosongkan', 'success');
            }
        }

        function downloadBarcode() {
            const barcode = document.getElementById('genBarcode').value || 'barcode';
            const previewContainer = document.getElementById('previewContainer');
            const canvas = previewContainer.querySelector('canvas');
            
            if (!canvas) {
                showToast('Generate barcode terlebih dahulu!', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.download = `barcode_${barcode}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showToast('Barcode berhasil diunduh!', 'success');
        }

        function downloadSingleBarcode(index) {
            const item = generatedBarcodes[index];
            const canvas = document.createElement('canvas');
            
            JsBarcode(canvas, item.barcode, {
                format: currentFormat,
                width: 2,
                height: 80,
                displayValue: true,
                fontSize: 16,
                font: 'monospace',
                margin: 10
            });
            
            const link = document.createElement('a');
            link.download = `barcode_${item.barcode}_${item.name.replace(/\s+/g, '_')}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            showToast(`Barcode ${item.barcode} diunduh!`, 'success');
        }

        function printBarcode() {
            const previewContainer = document.getElementById('previewContainer');
            const name = document.getElementById('genName').value;
            const canvas = previewContainer.querySelector('canvas');
            
            if (!canvas) {
                showToast('Generate barcode terlebih dahulu!', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print Barcode</title>
                    <style>
                        body { 
                            display: flex; 
                            justify-content: center; 
                            align-items: center; 
                            height: 100vh; 
                            margin: 0;
                            font-family: Arial, sans-serif;
                        }
                        .container { text-align: center; }
                        img { max-width: 100%; height: auto; }
                        .name { 
                            margin-top: 10px; 
                            font-size: 18px; 
                            font-weight: bold;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <img src="${canvas.toDataURL()}" />
                        <div class="name">${name}</div>
                    </div>
                    <script>
                        window.onload = function() { 
                            setTimeout(function() {
                                window.print();
                            }, 100);
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function generateAllBarcodes() {
            if (isStudentMode) {
                showToast('Siswa tidak dapat generate barcode!', 'error');
                return;
            }
            
            const allStudents = Object.entries(studentDatabase);
            let count = 0;
            
            allStudents.forEach(([barcode, data]) => {
                const exists = generatedBarcodes.find(item => item.barcode === barcode);
                if (!exists) {
                    generatedBarcodes.push({
                        barcode: barcode,
                        name: data.name,
                        class: data.class,
                        major: data.major,
                        timestamp: new Date().getTime()
                    });
                    count++;
                }
            });
            
            updateGeneratedList();
            showToast(`${count} barcode berhasil digenerate!`, 'success');
        }

        function downloadAllBarcodes() {
            if (isStudentMode) {
                showToast('Siswa tidak dapat download barcode!', 'error');
                return;
            }
            
            if (generatedBarcodes.length === 0) {
                showToast('Tidak ada barcode untuk diunduh!', 'error');
                return;
            }
            
            showToast(`Mengunduh ${generatedBarcodes.length} barcode...`, 'success');
            
            generatedBarcodes.forEach((item, index) => {
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    JsBarcode(canvas, item.barcode, {
                        format: currentFormat,
                        width: 2,
                        height: 80,
                        displayValue: true,
                        fontSize: 16,
                        font: 'monospace',
                        margin: 10
                    });
                    
                    const link = document.createElement('a');
                    link.download = `barcode_${item.barcode}_${item.name.replace(/\s+/g, '_')}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }, index * 200);
            });
        }

        // ============================================
        // CHAT FUNCTIONS (jika ada)
        // ============================================
        function openChatModal() {
            document.getElementById('chatModal').classList.add('active');
            document.getElementById('chatBadge').classList.remove('show');
            unreadMessages = 0;
            loadChatMessages();
            startChatListener();
            
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 100);
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.remove('active');
            if (chatListener) {
                chatListener.off();
                chatListener = null;
            }
        }

        function startChatListener() {
            if (!firebaseDB || isStudentMode) return;
            
            const chatRef = firebaseDB.ref('chat/messages');
            
            if (chatListener) {
                chatListener.off();
            }
            
            chatListener = chatRef.limitToLast(50).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message) {
                    displayChatMessage(message);
                    
                    if (!document.getElementById('chatModal').classList.contains('active')) {
                        if (message.senderId !== (currentUser ? currentUser.username : '')) {
                            unreadMessages++;
                            updateChatBadge();
                            
                            if (Notification.permission === 'granted') {
                                sendPushNotification('Pesan Baru dari ' + message.senderName, message.text, {
                                    type: 'chat',
                                    sender: message.senderName
                                });
                            }
                        }
                    }
                }
            });
        }

        function updateChatBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 99 ? '99+' : unreadMessages;
                badge.classList.add('show');
            } else {
                badge.classList.remove('show');
            }
        }

        function loadChatMessages() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '<div class="chat-empty-state"><i class="fas fa-spinner fa-spin"></i><p>Memuat pesan...</p></div>';
            
            if (!firebaseDB) {
                container.innerHTML = '<div class="chat-empty-state"><i class="fas fa-exclamation-circle"></i><p>Chat tidak tersedia offline</p></div>';
                return;
            }
            
            const chatRef = firebaseDB.ref('chat/messages');
            chatRef.limitToLast(50).once('value', (snapshot) => {
                const messages = snapshot.val();
                container.innerHTML = '';
                
                if (!messages) {
                    container.innerHTML = '<div class="chat-empty-state"><i class="fas fa-comments"></i><p>Belum ada pesan. Mulai chat sekarang!</p></div>';
                    return;
                }
                
                let lastDate = null;
                
                Object.values(messages).forEach((message) => {
                    const msgDate = new Date(message.timestamp).toDateString();
                    if (msgDate !== lastDate) {
                        addDateDivider(container, message.timestamp);
                        lastDate = msgDate;
                    }
                    
                    appendMessageToContainer(container, message);
                });
                
                scrollToBottom();
            });
        }

        function addDateDivider(container, timestamp) {
            const date = new Date(timestamp);
            const dateStr = date.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const divider = document.createElement('div');
            divider.className = 'chat-date-divider';
            divider.innerHTML = `<span>${dateStr}</span>`;
            container.appendChild(divider);
        }

        function displayChatMessage(message) {
            const container = document.getElementById('chatMessages');
            
            const emptyState = container.querySelector('.chat-empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const lastDivider = container.querySelector('.chat-date-divider:last-of-type');
            const msgDate = new Date(message.timestamp).toDateString();
            const lastDate = lastDivider ? new Date(lastDivider.querySelector('span').textContent).toDateString() : null;
            
            if (msgDate !== lastDate) {
                addDateDivider(container, message.timestamp);
            }
            
            appendMessageToContainer(container, message);
            scrollToBottom();
        }

        function appendMessageToContainer(container, message) {
            const isOwn = message.senderId === (currentUser ? currentUser.username : '');
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${isOwn ? 'own' : 'other'}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            msgDiv.innerHTML = `
                <div class="chat-message-header">
                    <span class="chat-message-sender">${message.senderName}</span>
                    <span class="chat-message-time">${time}</span>
                </div>
                <div class="chat-message-text">${escapeHtml(message.text)}</div>
            `;
            
            container.appendChild(msgDiv);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            container.scrollTop = container.scrollHeight;
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !firebaseDB || !currentUser) return;
            
            const message = {
                text: text,
                senderId: currentUser.username,
                senderName: currentUser.name,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            firebaseDB.ref('chat/messages').push(message)
                .then(() => {
                    input.value = '';
                    input.focus();
                })
                .catch((error) => {
                    showToast('Gagal mengirim pesan: ' + error.message, 'error');
                });
        }

        // Inisialisasi awal
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            initDB();
            initFirebase();
            updateDateDisplay();
            initPWA();
            
            const now = new Date();
            document.getElementById('rekapBulan').value = now.getMonth();
            document.getElementById('rekapTahun').value = now.getFullYear();
            
            initGuide();
            loadBackupHistory();
            checkNotificationPermission();
            
            setInterval(checkDateChange, 60000);
            
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    checkDateChange();
                }
            });

            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            updateFingerprintUI();
        });
    </script>
</body>
</html>